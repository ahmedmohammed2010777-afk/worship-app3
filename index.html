<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ù…Ø­Ø±Ø§Ø¨ Ø¹Ø§Ø¦Ù„ØªÙŠ - Ø§Ù„Ù†Ø³Ø®Ø© Ø§Ù„Ø³Ù†ÙˆÙŠØ© Ø§Ù„Ù…ØªØ¬Ø¯Ø¯Ø©</title>
    <link href="https://fonts.googleapis.com/css2?family=Amiri:wght@400;700&family=Tajawal:wght@400;700&display=swap" rel="stylesheet">
    <style>
        :root {
            --gold: #b8860b; --emerald: #2e7d32; --dark-red: #d32f2f; --soft-bg: #f4f7f6;
            --wa-bg: #e5ddd5; --wa-green: #075e54; --wa-light: #dcf8c6;
        }
        body { font-family: 'Tajawal', sans-serif; background-color: var(--soft-bg); margin: 0; padding: 10px; color: #333; }
        .container { max-width: 900px; margin: 0 auto; }

        /* Ø§Ù„Ù‡ÙŠØ¯Ø± */
        .app-header { text-align: center; color: var(--wa-green); margin-bottom: 20px; }
        .luxury-card { background: white; border-radius: 20px; padding: 12px; margin-bottom: 15px; box-shadow: 0 10px 25px rgba(0,0,0,0.08); border: 1px solid rgba(184, 134, 11, 0.2); }
        .card-inner { border: 2px double var(--gold); border-radius: 15px; padding: 15px; text-align: center; }
        .naskh-font { font-family: 'Amiri', serif; font-size: 1.3rem; line-height: 1.6; margin: 8px 0; font-weight: bold; }

        /* Ø§Ù„Ù…ØªÙ†Ø§ÙØ³ÙˆÙ† */
        .family-selector { display: flex; justify-content: center; gap: 8px; margin-bottom: 20px; flex-wrap: wrap; }
        .user-btn { padding: 8px 15px; border-radius: 20px; border: 2px solid var(--wa-green); background: white; color: var(--wa-green); cursor: pointer; font-weight: bold; font-size: 0.9rem; transition: 0.3s; }
        .user-btn.active { background: var(--wa-green); color: white; box-shadow: 0 4px 10px rgba(0,0,0,0.1); }

        /* Ø§Ù„Ø¨ÙˆØ¯ÙŠÙˆÙ… ÙˆÙƒØ´Ù Ø§Ù„Ù…ØªØ¨Ù‚ÙŠ */
        .podium-container { background: white; border-radius: 20px; padding: 20px; margin-bottom: 20px; text-align: center; }
        .podium-flex { display: flex; align-items: flex-end; justify-content: center; gap: 6px; height: 260px; margin-top: 35px; }
        .podium-step { flex: 1; display: flex; flex-direction: column; align-items: center; border-radius: 12px 12px 0 0; position: relative; padding-bottom: 10px; min-width: 85px; transition: all 0.5s ease; }
        .step-1 { background: linear-gradient(to top, #ffd700, #fffde7); height: 100%; border: 1px solid #ffcc00; }
        .step-2 { background: linear-gradient(to top, #c0c0c0, #f5f5f5); height: 80%; border: 1px solid #bdbdbd; }
        .step-3 { background: linear-gradient(to top, #cd7f32, #efebe9); height: 68%; border: 1px solid #a1887f; }
        .step-4 { background: #f0f0f0; height: 55%; border: 1px solid #ccc; }
        .medal { font-size: 1.6rem; position: absolute; top: -35px; }
        
        .remain-box { font-size: 0.62rem; color: #444; background: rgba(255,255,255,0.85); padding: 4px; border-radius: 6px; margin-top: 5px; width: 92%; max-height: 90px; overflow-y: auto; text-align: right; border: 1px dashed var(--dark-red); }
        .remain-item { display: block; color: var(--dark-red); border-bottom: 1px solid #eee; padding: 2px 0; }

        /* Ø§Ù„Ø£Ù‚Ø³Ø§Ù… */
        .section-box { background: white; border-radius: 15px; padding: 18px; margin-bottom: 15px; box-shadow: 0 4px 15px rgba(0,0,0,0.03); }
        .section-title { border-right: 5px solid var(--wa-green); padding-right: 10px; margin-bottom: 15px; color: var(--wa-green); font-weight: bold; }
        .task-row { display: flex; align-items: center; justify-content: space-between; padding: 12px 0; border-bottom: 1px solid #f5f5f5; }
        .sunnah-badge { font-size: 0.7rem; background: #e8f5e9; color: var(--emerald); padding: 2px 8px; border-radius: 10px; font-weight: bold; border: 1px solid #c8e6c9; }
        .ext-link { color: var(--emerald); text-decoration: none; font-size: 0.9rem; margin-left: 5px; }

        .opt-btn { font-size: 0.65rem; padding: 6px 9px; border-radius: 6px; border: 1px solid #ddd; cursor: pointer; background: white; }
        .opt-btn.active-masjid { background: var(--emerald); color: white; }
        .opt-btn.active-fard { background: #2196F3; color: white; }
        .opt-btn.active-qada { background: #757575; color: white; }

        /* Ù…Ù„ØªÙ‚Ù‰ Ø§Ù„Ø·Ø§Ø¹Ø© */
        .chat-section { background: var(--wa-bg); border-radius: 20px; overflow: hidden; margin-top: 20px; border: 1px solid #ccc; }
        .chat-header { background: var(--wa-green); color: white; padding: 12px; font-weight: bold; text-align: center; }
        .chat-messages { height: 250px; overflow-y: auto; padding: 15px; display: flex; flex-direction: column; gap: 10px; }
        .msg { max-width: 85%; padding: 8px 12px; border-radius: 12px; font-size: 0.9rem; box-shadow: 0 1px 2px rgba(0,0,0,0.1); }
        .msg-received { background: white; align-self: flex-start; border-top-right-radius: 0; }
        .msg-sent { background: var(--wa-light); align-self: flex-end; border-top-left-radius: 0; }
        .msg-info { font-size: 0.7rem; color: var(--wa-green); margin-bottom: 3px; display: block; font-weight: bold; }
        .chat-input-area { background: #f0f0f0; padding: 10px; display: flex; gap: 10px; }
        .chat-input { flex: 1; padding: 10px; border-radius: 20px; border: 1px solid #ccc; outline: none; }
        .send-btn { background: var(--wa-green); color: white; border: none; border-radius: 50%; width: 40px; height: 40px; cursor: pointer; display: flex; align-items: center; justify-content: center; }
    </style>
</head>
<body>

<div class="container">
    <div class="app-header">
        <h1>ğŸ•Œ Ù…Ø­Ø±Ø§Ø¨ Ø¹Ø§Ø¦Ù„ØªÙŠ</h1>
        <input type="date" id="main-calendar" onchange="init()" style="padding: 10px; border-radius: 10px; border: 2px solid var(--gold); font-family: 'Tajawal';">
        <h2 id="display-date" style="color: var(--gold); margin-top: 8px;"></h2>
    </div>

    <div id="spiritual-header"></div>

    <div class="family-selector">
        <button class="user-btn active" onclick="switchUser(0)">Ø§Ù„Ø£Ø¨ Ù…Ø­Ù…Ø¯</button>
        <button class="user-btn" onclick="switchUser(1)">Ø§Ù„Ø£Ù… Ø´ÙŠÙ…Ø§Ø¡</button>
        <button class="user-btn" onclick="switchUser(2)">Ø£Ø­Ù…Ø¯</button>
        <button class="user-btn" onclick="switchUser(3)">ÙŠØ§Ø³ÙŠÙ†</button>
    </div>

    <div class="podium-container">
        <h3 style="color: var(--wa-green); margin: 0; font-size: 1.1rem;">ğŸ† Ø­ØµØ§Ø¯ Ø§Ù„Ø·Ø§Ø¹Ø§Øª ÙˆØ§Ù„ØªØ±ØªÙŠØ¨</h3>
        <div class="podium-flex" id="podium-ui"></div>
    </div>

    <div id="tasks-content">
        <div class="section-box"><h3 class="section-title">Ø§Ù„ÙØ±ÙˆØ¶ Ø§Ù„Ø®Ù…Ø³Ø©</h3><div id="fard-list"></div></div>
        <div class="section-box"><h3 class="section-title">Ø§Ù„Ø³Ù†Ù† Ø§Ù„Ø±ÙˆØ§ØªØ¨ (Ù…ÙØµÙ„Ø©)</h3><div id="sunnah-list"></div></div>
        <div class="section-box">
            <h3 class="section-title">Ø§Ù„Ø£Ø°ÙƒØ§Ø± ÙˆØ§Ù„Ù‚Ø±Ø¢Ù† (Ø§Ø¶ØºØ· Ù„Ù„Ù‚Ø±Ø§Ø¡Ø©)</h3>
            <div id="daily-words"></div>
            <div id="kahf-area"></div>
        </div>
    </div>

    <div class="chat-section">
        <div class="chat-header">ğŸ’¬ Ù…Ù„ØªÙ‚Ù‰ Ø§Ù„Ø¹Ø§Ø¦Ù„Ø© Ø¹Ù„Ù‰ Ø§Ù„Ø·Ø§Ø¹Ø©</div>
        <div class="chat-messages" id="chat-box"></div>
        <div class="chat-input-area">
            <input type="text" id="chat-input" class="chat-input" placeholder="Ø§ÙƒØªØ¨ Ø±Ø³Ø§Ù„Ø© ØªØ´Ø¬ÙŠØ¹ÙŠØ©...">
            <button class="send-btn" onclick="sendMessage()">âœˆ</button>
        </div>
    </div>
</div>

<script>
    // Ù…ÙƒØªØ¨Ø© Ø´Ø§Ù…Ù„Ø© - Ø§Ù„Ø®ÙˆØ§Ø±Ø²Ù…ÙŠØ© ØªØ®ØªØ§Ø± Ø¨Ù†Ø§Ø¡Ù‹ Ø¹Ù„Ù‰ Ø±Ù‚Ù… Ø§Ù„ÙŠÙˆÙ… ÙÙŠ Ø§Ù„Ø³Ù†Ø©
    const library = {
        hadiths: [
            "Ù‚Ø§Ù„ ï·º: Â«Ø®ÙÙŠÙ’Ø±ÙÙƒÙÙ…Ù’ Ù…ÙÙ†Ù’ ØªÙØ¹ÙÙ„Ù‘ÙÙ…Ù Ø§Ù„Ù’Ù‚ÙØ±Ù’Ø¢Ù†Ù ÙˆÙØ¹ÙÙ„Ù‘ÙÙ…ÙÙ‡ÙÂ»",
            "Ù‚Ø§Ù„ ï·º: Â«Ù…ÙÙ†Ù’ ØµÙÙ„Ù‘ÙÙ‰ ÙÙÙŠ ÙŠÙÙˆÙ’Ù…Ù ÙˆÙÙ„ÙÙŠÙ’Ù„ÙØ©Ù Ø«ÙÙ†Ù’ØªÙÙŠÙ’ Ø¹ÙØ´Ù’Ø±ÙØ©Ù Ø±ÙÙƒÙ’Ø¹ÙØ©Ù‹ Ø¨ÙÙ†ÙÙŠÙ Ù„ÙÙ‡Ù Ø¨ÙÙŠÙ’ØªÙŒ ÙÙÙŠ Ø§Ù„Ù’Ø¬ÙÙ†Ù‘ÙØ©ÙÂ»",
            "Ù‚Ø§Ù„ ï·º: Â«Ø£ÙØ­ÙØ¨Ù‘Ù Ø§Ù„Ø£ÙØ¹Ù’Ù…ÙØ§Ù„Ù Ø¥ÙÙ„ÙÙ‰ Ø§Ù„Ù„Ù‘ÙÙ‡Ù Ø£ÙØ¯Ù’ÙˆÙÙ…ÙÙ‡ÙØ§ ÙˆÙØ¥ÙÙ†Ù’ Ù‚ÙÙ„Ù‘ÙÂ»",
            "Ù‚Ø§Ù„ ï·º: Â«ÙƒÙÙ„ÙÙ…ÙØªÙØ§Ù†Ù Ø®ÙÙÙÙŠÙÙØªÙØ§Ù†Ù Ø¹ÙÙ„ÙÙ‰ Ø§Ù„Ù„ÙÙ‘Ø³ÙØ§Ù†Ù.. Ø³ÙØ¨Ù’Ø­ÙØ§Ù†Ù Ø§Ù„Ù„ÙÙ‘Ù‡Ù ÙˆÙØ¨ÙØ­ÙÙ…Ù’Ø¯ÙÙ‡ÙÂ»",
            "Ù‚Ø§Ù„ ï·º: Â«Ù…ÙÙ†Ù’ Ù„ÙØ²ÙÙ…Ù Ø§Ù„ÙØ§Ø³Ù’ØªÙØºÙ’ÙÙØ§Ø±Ù Ø¬ÙØ¹ÙÙ„Ù Ø§Ù„Ù„Ù‘ÙÙ‡Ù Ù„ÙÙ‡Ù Ù…ÙÙ†Ù’ ÙƒÙÙ„Ù‘Ù Ø¶ÙÙŠÙ‚Ù Ù…ÙØ®Ù’Ø±ÙØ¬Ù‹Ø§Â»",
            "Ù‚Ø§Ù„ ï·º: Â«Ø§Ù„Ø¯Ø§Ù„ Ø¹Ù„Ù‰ Ø§Ù„Ø®ÙŠØ± ÙƒÙØ§Ø¹Ù„Ù‡Â»",
            "Ù‚Ø§Ù„ ï·º: Â«Ù…ÙÙ†Ù’ Ù‚ÙØ±ÙØ£Ù Ø­ÙØ±Ù’ÙÙ‹Ø§ Ù…ÙÙ†Ù’ ÙƒÙØªÙØ§Ø¨Ù Ø§Ù„Ù„Ù‘ÙÙ‡Ù ÙÙÙ„ÙÙ‡Ù Ø¨ÙÙ‡Ù Ø­ÙØ³ÙÙ†ÙØ©ÙŒÂ»",
            "Ù‚Ø§Ù„ ï·º: Â«Ø§ØªÙ‘ÙÙ‚ÙÙˆØ§ Ø§Ù„Ù„Ù‘ÙÙ‡Ù ÙˆÙÙ„ÙÙˆÙ’ Ø¨ÙØ´ÙÙ‚Ù‘Ù ØªÙÙ…Ù’Ø±ÙØ©ÙÂ»",
            "Ù‚Ø§Ù„ ï·º: Â«Ù…ÙÙ†Ù’ Ø³ÙÙ„ÙÙƒÙ Ø·ÙØ±ÙÙŠÙ‚Ù‹Ø§ ÙŠÙÙ„Ù’ØªÙÙ…ÙØ³Ù ÙÙÙŠÙ‡Ù Ø¹ÙÙ„Ù’Ù…Ù‹Ø§ Ø³ÙÙ‡Ù‘ÙÙ„Ù Ø§Ù„Ù„Ù‘ÙÙ‡Ù Ù„ÙÙ‡Ù Ø¨ÙÙ‡Ù Ø·ÙØ±ÙÙŠÙ‚Ù‹Ø§ Ø¥ÙÙ„ÙÙ‰ Ø§Ù„Ù’Ø¬ÙÙ†Ù‘ÙØ©ÙÂ»",
            "Ù‚Ø§Ù„ ï·º: Â«ØªÙØ¨ÙØ³Ù‘ÙÙ…ÙÙƒÙ ÙÙÙŠ ÙˆÙØ¬Ù’Ù‡Ù Ø£ÙØ®ÙÙŠÙƒÙ Ù„ÙÙƒÙ ØµÙØ¯ÙÙ‚ÙØ©ÙŒÂ»"
        ],
        flashes: [
            "Ø§Ù„Ø¶Ø­Ù‰ ØµÙ„Ø§Ø© Ø§Ù„Ø£ÙˆØ§Ø¨ÙŠÙ†.. Ø§Ø¨Ø¯Ø£ ÙŠÙˆÙ…Ùƒ Ø¨ØµØ¯Ù‚Ø© Ø¹Ù† Ù…ÙØ§ØµÙ„Ùƒ.",
            "Ø£Ø°ÙƒØ§Ø± Ø§Ù„Ù†ÙˆÙ… Ø­ØµÙ†Ùƒ Ø§Ù„Ø­ØµÙŠÙ† ÙˆØ¬Ù†ØªÙƒ Ù‚Ø¨Ù„ Ø§Ù„Ù…Ù†Ø§Ù….",
            "Ø§Ù„ÙˆØªØ± Ø¬Ù†Ø© Ø§Ù„Ù‚Ù„ÙˆØ¨.. Ù„Ø§ ØªÙ†Ù… Ù‚Ø¨Ù„ Ø£Ù† ØªØ¶Ø¹ Ø¨ØµÙ…Ø© Ù†ÙˆØ± ÙÙŠ Ù„ÙŠÙ„Ùƒ.",
            "ÙˆØ±Ø¯Ùƒ Ø§Ù„Ù‚Ø±Ø¢Ù†ÙŠ Ù‡Ùˆ Ø§Ù„ÙˆÙ‚ÙˆØ¯ Ø§Ù„Ø°ÙŠ ÙŠØ¶ÙŠØ¡ Ø±ÙˆØ­Ùƒ Ø·ÙˆØ§Ù„ Ø§Ù„ÙŠÙˆÙ….",
            "Ø§Ø¨ØªØ³Ø§Ù…ØªÙƒ ÙÙŠ ÙˆØ¬Ù‡ Ø£Ø®ÙŠÙƒ ØµØ¯Ù‚Ø©.. Ø§Ù†Ø´Ø± Ø§Ù„Ø­Ø¨ ÙÙŠ Ø¨ÙŠØªÙƒ.",
            "ØµÙ„Ø§Ø© Ø§Ù„ÙØ¬Ø± Ù‡ÙŠ Ù…Ù‚ÙŠØ§Ø³ Ø­Ø¨Ùƒ Ù„Ù„Ù‡ Ø¹Ø² ÙˆØ¬Ù„.",
            "Ø¨Ø± Ø§Ù„ÙˆØ§Ù„Ø¯ÙŠÙ† Ø¨Ø§Ø¨ Ù…Ù† Ø£Ø¨ÙˆØ§Ø¨ Ø§Ù„Ø¬Ù†Ø© Ù…ÙØªÙˆØ­ Ø£Ù…Ø§Ù…Ùƒ.",
            "Ù…Ø§ Ù†Ù‚Øµ Ù…Ø§Ù„ Ù…Ù† ØµØ¯Ù‚Ø©.. Ø¬Ø±Ø¨ Ø£Ù† ØªØªØµØ¯Ù‚ Ø§Ù„ÙŠÙˆÙ… ÙˆÙ„Ùˆ Ø¨Ø§Ù„Ù‚Ù„ÙŠÙ„.",
            "Ø¬Ø¯Ø¯ Ù†ÙŠØªÙƒ ÙÙŠ ÙƒÙ„ Ø¹Ù…Ù„ ØªÙ‚ÙˆÙ… Ø¨Ù‡ØŒ ÙØ¨Ø§Ù„Ù†ÙŠØ© ØªØªØ­ÙˆÙ„ Ø§Ù„Ø¹Ø§Ø¯Ø§Øª Ø¥Ù„Ù‰ Ø¹Ø¨Ø§Ø¯Ø§Øª.",
            "Ø£ÙƒØ«Ø± Ù…Ù† Ø§Ù„ØµÙ„Ø§Ø© Ø¹Ù„Ù‰ Ø§Ù„Ù†Ø¨ÙŠ ï·º Ù„ÙŠÙ„Ø© Ø§Ù„Ø¬Ù…Ø¹Ø© ÙˆÙŠÙˆÙ…Ù‡Ø§."
        ]
    };

    const sunnahData = [
        {id: "s1", n: "Ø³Ù†Ø© Ø§Ù„ÙØ¬Ø±", type: "Ù‚Ø¨Ù„ÙŠØ©", r: "2 Ø±ÙƒØ¹Ø©"},
        {id: "s2", n: "Ø³Ù†Ø© Ø§Ù„Ø¸Ù‡Ø±", type: "Ù‚Ø¨Ù„ÙŠØ©", r: "4 Ø±ÙƒØ¹Ø§Øª"},
        {id: "s3", n: "Ø³Ù†Ø© Ø§Ù„Ø¸Ù‡Ø±", type: "Ø¨Ø¹Ø¯ÙŠØ©", r: "2 Ø±ÙƒØ¹Ø©"},
        {id: "s4", n: "Ø³Ù†Ø© Ø§Ù„Ù…ØºØ±Ø¨", type: "Ø¨Ø¹Ø¯ÙŠØ©", r: "2 Ø±ÙƒØ¹Ø©"},
        {id: "s5", n: "Ø³Ù†Ø© Ø§Ù„Ø¹Ø´Ø§Ø¡", type: "Ø¨Ø¹Ø¯ÙŠØ©", r: "2 Ø±ÙƒØ¹Ø©"},
        {id: "s6", n: "ØµÙ„Ø§Ø© Ø§Ù„Ø¶Ø­Ù‰", type: "Ù†Ø§ÙÙ„Ø©", r: "2-8 Ø±ÙƒØ¹Ø§Øª"},
        {id: "s7", n: "Ø§Ù„Ø´ÙØ¹ ÙˆØ§Ù„ÙˆØªØ±", type: "Ù†Ø§ÙÙ„Ø©", r: "3 Ø±ÙƒØ¹Ø§Øª"},
        {id: "s8", n: "Ù‚ÙŠØ§Ù… Ø§Ù„Ù„ÙŠÙ„", type: "Ù†Ø§ÙÙ„Ø©", r: "Ù…Ø«Ù†Ù‰ Ù…Ø«Ù†Ù‰"}
    ];

    let currentUserIdx = 0;
    let appStorage = JSON.parse(localStorage.getItem('mehrab_v2026_annual_links')) || { 
        family: [{ name: "Ø§Ù„Ø£Ø¨ Ù…Ø­Ù…Ø¯", tasks: {} }, { name: "Ø§Ù„Ø£Ù… Ø´ÙŠÙ…Ø§Ø¡", tasks: {} }, { name: "Ø£Ø­Ù…Ø¯", tasks: {} }, { name: "ÙŠØ§Ø³ÙŠÙ†", tasks: {} }],
        chats: {} 
    };

    function init() {
        const d = new Date(document.getElementById('main-calendar').value || new Date());
        const dateKey = d.toISOString().split('T')[0];
        
        // Ø­Ø³Ø§Ø¨ Ø±Ù‚Ù… Ø§Ù„ÙŠÙˆÙ… ÙÙŠ Ø§Ù„Ø³Ù†Ø© (1 - 366) Ù„Ø¶Ù…Ø§Ù† ØªØºÙŠØ± Ø§Ù„Ù…Ø­ØªÙˆÙ‰ ÙŠÙˆÙ…ÙŠØ§Ù‹
        const start = new Date(d.getFullYear(), 0, 0);
        const diff = d - start;
        const oneDay = 1000 * 60 * 60 * 24;
        const dayOfYear = Math.floor(diff / oneDay);

        document.getElementById('display-date').innerText = d.toLocaleDateString('ar-EG', {weekday:'long', day:'numeric', month:'long'});
        
        // Ø§Ø®ØªÙŠØ§Ø± Ø§Ù„ÙÙ‡Ø±Ø³ Ø¨Ù†Ø§Ø¡Ù‹ Ø¹Ù„Ù‰ Ø±Ù‚Ù… Ø§Ù„ÙŠÙˆÙ…
        const hIdx = dayOfYear % library.hadiths.length;
        const fIdx = dayOfYear % library.flashes.length;

        document.getElementById('spiritual-header').innerHTML = `
            <div class="luxury-card"><div class="card-inner"><span style="color:var(--gold)">âœ¨ Ø­Ø¯ÙŠØ« Ø§Ù„ÙŠÙˆÙ…</span><p class="naskh-font">${library.hadiths[hIdx]}</p></div></div>
            <div class="luxury-card" style="border-color:var(--emerald)"><div class="card-inner" style="border-color:var(--emerald)"><span style="color:var(--emerald)">ğŸ’¡ ÙˆÙ…Ø¶Ø© Ø§Ù„ÙŠÙˆÙ…</span><p class="naskh-font" style="font-size:1.1rem">${library.flashes[fIdx]}</p></div></div>
        `;

        renderTasks(dateKey, d.getDay() === 5);
        updatePodium(dateKey, d.getDay() === 5);
        loadChat(dateKey);
    }

    function switchUser(idx) {
        currentUserIdx = idx;
        document.querySelectorAll('.user-btn').forEach((b, i) => b.classList.toggle('active', i === idx));
        init();
    }

    function renderTasks(dateKey, isFriday) {
        const user = appStorage.family[currentUserIdx];
        if(!user.tasks[dateKey]) user.tasks[dateKey] = {};
        
        const fList = document.getElementById('fard-list'); fList.innerHTML = "";
        ["Ø§Ù„ÙØ¬Ø±", "Ø§Ù„Ø¸Ù‡Ø±", "Ø§Ù„Ø¹ØµØ±", "Ø§Ù„Ù…ØºØ±Ø¨", "Ø§Ù„Ø¹Ø´Ø§Ø¡"].forEach((p, i) => {
            let pName = (isFriday && i === 1) ? "Ø§Ù„Ø¬Ù…Ø¹Ø©" : p;
            let val = user.tasks[dateKey][pName] || "";
            fList.innerHTML += `
                <div class="task-row">
                    <span><b>${pName}</b></span>
                    <div class="prayer-options">
                        <button class="opt-btn ${val==='masjid'?'active-masjid':''}" onclick="saveTask('${dateKey}','${pName}','masjid')">ğŸ•Œ Ù…Ø³Ø¬Ø¯</button>
                        <button class="opt-btn ${val==='fard'?'active-fard':''}" onclick="saveTask('${dateKey}','${pName}','fard')">ğŸ‘¤ ÙØ±Ø¯</button>
                        <button class="opt-btn ${val==='qada'?'active-qada':''}" onclick="saveTask('${dateKey}','${pName}','qada')">ğŸ•’ Ù‚Ø¶Ø§Ø¡</button>
                    </div>
                </div>`;
        });

        const sList = document.getElementById('sunnah-list'); sList.innerHTML = "";
        sunnahData.forEach(s => {
            sList.innerHTML += `<div class="task-row">
                <span>${s.n} <span class="sunnah-badge">${s.type} (${s.r})</span></span>
                <input type="checkbox" ${user.tasks[dateKey][s.id]?'checked':''} onchange="saveCheck('${dateKey}','${s.id}', this.checked)">
            </div>`;
        });

        const wList = document.getElementById('daily-words'); 
        const azkarBase = "https://alazkar.today/";
        const quranBase = "https://quran.com/";
        const items = [
            {id: 'az_sabah', n: 'Ø£Ø°ÙƒØ§Ø± Ø§Ù„ØµØ¨Ø§Ø­', link: azkarBase}, 
            {id: 'az_masa', n: 'Ø£Ø°ÙƒØ§Ø± Ø§Ù„Ù…Ø³Ø§Ø¡', link: azkarBase}, 
            {id: 'az_noom', n: 'Ø£Ø°ÙƒØ§Ø± Ø§Ù„Ù†ÙˆÙ…', link: azkarBase}, 
            {id: 'quran', n: 'Ø§Ù„ÙˆØ±Ø¯ Ø§Ù„Ù‚Ø±Ø¢Ù†ÙŠ', link: quranBase}, 
            {id: 'milk', n: 'Ø³ÙˆØ±Ø© Ø§Ù„Ù…Ù„Ùƒ', link: quranBase + "67"}
        ];
        wList.innerHTML = "";
        items.forEach(a => {
            wList.innerHTML += `
                <div class="task-row">
                    <span><a href="${a.link}" target="_blank" class="ext-link">ğŸ”—</a> ${a.n}</span>
                    <input type="checkbox" ${user.tasks[dateKey][a.id]?'checked':''} onchange="saveCheck('${dateKey}','${a.id}', this.checked)">
                </div>`;
        });
        
        const kArea = document.getElementById('kahf-area');
        if(isFriday) {
            kArea.innerHTML = `
                <div class="task-row" style="color:var(--emerald); font-weight:bold;">
                    <span><a href="${quranBase}18" target="_blank" class="ext-link">ğŸ”—</a> Ø³ÙˆØ±Ø© Ø§Ù„ÙƒÙ‡Ù</span>
                    <input type="checkbox" ${user.tasks[dateKey]['kahf']?'checked':''} onchange="saveCheck('${dateKey}','kahf', this.checked)">
                </div>`;
        } else { kArea.innerHTML = ""; }
    }

    function saveTask(dKey, p, t) { appStorage.family[currentUserIdx].tasks[dKey][p] = (appStorage.family[currentUserIdx].tasks[dKey][p] === t) ? "" : t; saveAll(); init(); }
    function saveCheck(dKey, k, v) { appStorage.family[currentUserIdx].tasks[dKey][k] = v; saveAll(); init(); }
    function saveAll() { localStorage.setItem('mehrab_v2026_annual_links', JSON.stringify(appStorage)); }

    function updatePodium(dKey, isFriday) {
        const tracked = ["Ø§Ù„ÙØ¬Ø±", isFriday?"Ø§Ù„Ø¬Ù…Ø¹Ø©":"Ø§Ù„Ø¸Ù‡Ø±", "Ø§Ù„Ø¹ØµØ±", "Ø§Ù„Ù…ØºØ±Ø¨", "Ø§Ù„Ø¹Ø´Ø§Ø¡", "s1", "s2", "s3", "s4", "s5", "s6", "s7", "s8", "az_sabah", "az_masa", "az_noom", "quran", "milk"];
        if(isFriday) tracked.push("kahf");

        const results = appStorage.family.map(u => {
            let done = 0, remains = [];
            tracked.forEach(tid => {
                let v = u.tasks[dKey]?.[tid];
                if(v === true || v === 'masjid' || v === 'fard' || v === 'qada') done++;
                else {
                    let label = tid.startsWith('s') ? sunnahData.find(s=>s.id===tid).n : tid;
                    if(label === 'az_sabah') label = 'Ø£Ø°ÙƒØ§Ø± Ø§Ù„ØµØ¨Ø§Ø­';
                    if(label === 'az_masa') label = 'Ø£Ø°ÙƒØ§Ø± Ø§Ù„Ù…Ø³Ø§Ø¡';
                    if(label === 'az_noom') label = 'Ø£Ø°ÙƒØ§Ø± Ø§Ù„Ù†ÙˆÙ…';
                    remains.push(label);
                }
            });
            return { name: u.name, score: Math.round((done/tracked.length)*100), remains };
        });

        const sorted = [...results].sort((a,b) => b.score - a.score);
        const ui = document.getElementById('podium-ui'); ui.innerHTML = "";
        [sorted[1], sorted[0], sorted[2], sorted[3]].forEach(m => {
            if(!m) return;
            let step = m === sorted[0] ? "step-1" : (m === sorted[1] ? "step-2" : (m === sorted[2] ? "step-3" : "step-4"));
            let rHtml = m.remains.length > 0 ? m.remains.map(r => `<span class="remain-item">${r}</span>`).join('') : '<span style="color:var(--emerald)">ØªÙ… Ø§Ù„Ø¥Ù†Ø¬Ø§Ø²! âœ¨</span>';
            ui.innerHTML += `<div class="podium-step ${step}"><span class="medal">${m===sorted[0]?'ğŸ¥‡':m===sorted[1]?'ğŸ¥ˆ':m===sorted[2]?'ğŸ¥‰':'ğŸ…'}</span><b style="font-size:0.75rem">${m.name.split(' ')[0]}</b><span>${m.score}%</span><div class="remain-box">${rHtml}</div></div>`;
        });
    }

    function loadChat(dateKey) {
        const box = document.getElementById('chat-box'); box.innerHTML = "";
        const msgs = appStorage.chats[dateKey] || [];
        if(msgs.length === 0) box.innerHTML = `<p style="text-align:center; color:#888; font-size:0.8rem;">Ø¨Ø¯Ø§ÙŠØ© ÙŠÙˆÙ… Ø¬Ø¯ÙŠØ¯ Ù…Ù† Ø§Ù„Ø·Ø§Ø¹Ø©..</p>`;
        msgs.forEach(msg => {
            const isMe = msg.sender === appStorage.family[currentUserIdx].name;
            box.innerHTML += `<div class="msg ${isMe?'msg-sent':'msg-received'}"><span class="msg-info">${msg.sender}</span>${msg.text}</div>`;
        });
        box.scrollTop = box.scrollHeight;
    }

    function sendMessage() {
        const input = document.getElementById('chat-input');
        if(!input.value.trim()) return;
        const dKey = new Date(document.getElementById('main-calendar').value || new Date()).toISOString().split('T')[0];
        if(!appStorage.chats[dKey]) appStorage.chats[dKey] = [];
        appStorage.chats[dKey].push({ sender: appStorage.family[currentUserIdx].name, text: input.value });
        input.value = ""; saveAll(); loadChat(dKey);
    }

    window.onload = () => { document.getElementById('main-calendar').valueAsDate = new Date(); init(); };
</script>
</body>
</html>
