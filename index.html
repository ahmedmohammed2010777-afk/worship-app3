<!DOCTYPE html>
<html dir="rtl" lang="ar">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Ø³Ø¨Ø§Ù‚ Ø§Ù„Ø·Ø§Ø¹Ø© Ø§Ù„Ø¹Ø§Ø¦Ù„ÙŠ</title>

<script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
<script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
<script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
<script src="https://cdn.tailwindcss.com"></script>

<style>
@import url('https://fonts.googleapis.com/css2?family=Changa:wght@400;700;800&family=Amiri:wght@700&display=swap');

body { font-family: 'Changa', sans-serif; background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%); padding: 10px; color: #2d3436; min-height: 100vh; }
.neu-card { background: rgba(255, 255, 255, 0.8); backdrop-filter: blur(10px); box-shadow: 20px 20px 60px #bebebe, -20px -20px 60px #ffffff; border-radius: 30px; border: 1px solid rgba(255, 255, 255, 0.5); margin-bottom: 25px; padding: 20px; }
.neu-inset { background: #eef2f7; box-shadow: inset 6px 6px 12px #d1d9e6, inset -6px -6px 12px #ffffff; border-radius: 20px; }
.neu-btn { background: white; box-shadow: 5px 5px 15px rgba(0,0,0,0.1); transition: all 0.3s ease; border-radius: 15px; border: none; cursor: pointer; }
.neu-btn:active { transform: scale(0.95); box-shadow: inset 2px 2px 5px rgba(0,0,0,0.1); }

/* Ø§Ù„Ø£ÙØ§ØªØ§Ø± Ø§Ù„Ù…Ù„ÙƒÙŠ */
.royal-avatar { width: 60px; height: 60px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-weight: 800; font-size: 24px; color: white; text-shadow: 1px 1px 2px rgba(0,0,0,0.3); box-shadow: 0 10px 20px rgba(0,0,0,0.1), inset 0 -4px 8px rgba(0,0,0,0.2); border: 2px solid #fff; }
.av-m { background: linear-gradient(135deg, #b8860b 0%, #ffd700 50%, #b8860b 100%); }
.av-s { background: linear-gradient(135deg, #db2777 0%, #fbcfe8 100%); }
.av-a { background: linear-gradient(135deg, #1e3a8a 0%, #3b82f6 100%); }
.av-y { background: linear-gradient(135deg, #059669 0%, #34d399 100%); }

.hadith-card { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; border-right: 8px solid #ffd700; }
.podium-1 { background: linear-gradient(to top, #ffd700, #fff9c4); height: 120px; border-radius: 20px 20px 0 0; }
.podium-2 { background: linear-gradient(to top, #bdc3c7, #ebedee); height: 80px; border-radius: 20px 20px 0 0; }
.podium-3 { background: linear-gradient(to top, #cd7f32, #f5d1b0); height: 50px; border-radius: 20px 20px 0 0; }
</style>
</head>

<body>
<div id="root"></div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
import { getFirestore, doc, setDoc, onSnapshot, arrayUnion } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

const firebaseConfig = {
  apiKey: "AIzaSyDba3kZK5ibQEIRRjVIHL7JIOHixX_7rVs",
  authDomain: "ebada-656e1.firebaseapp.com",
  projectId: "ebada-656e1",
  storageBucket: "ebada-656e1.firebasestorage.app",
  messagingSenderId: "705608653939",
  appId: "1:705608653939:web:5ab3609a6f7ccc8675de06"
};

const app = initializeApp(firebaseConfig);
const db = getFirestore(app);
window.docRef = doc(db, "worship", "family");
window.db = db;
window.setDoc = setDoc;
window.onSnapshot = onSnapshot;
window.arrayUnion = arrayUnion;
window.docFunc = doc;
</script>

<script type="text/babel">
const { useState, useEffect, useRef } = React;

const hadiths = [
  "Â«Ø®ÙŠØ§Ø±ÙƒÙ… Ø®ÙŠØ§Ø±ÙƒÙ… Ù„Ø£Ù‡Ù„Ù‡Ù…Â»",
  "Â«Ø£Ø­Ø¨ Ø§Ù„Ø£Ø¹Ù…Ø§Ù„ Ø¥Ù„Ù‰ Ø§Ù„Ù„Ù‡ Ø£Ø¯ÙˆÙ…Ù‡Ø§ ÙˆØ¥Ù† Ù‚Ù„Â»",
  "Â«Ù…Ù† Ø³Ù„Ùƒ Ø·Ø±ÙŠÙ‚Ø§Ù‹ ÙŠÙ„ØªÙ…Ø³ ÙÙŠÙ‡ Ø¹Ù„Ù…Ø§Ù‹ Ø³Ù‡Ù„ Ø§Ù„Ù„Ù‡ Ù„Ù‡ Ø·Ø±ÙŠÙ‚Ø§Ù‹ Ø¥Ù„Ù‰ Ø§Ù„Ø¬Ù†Ø©Â»",
  "Â«Ø®ÙŠØ±ÙƒÙ… Ù…Ù† ØªØ¹Ù„Ù… Ø§Ù„Ù‚Ø±Ø¢Ù† ÙˆØ¹Ù„Ù…Ù‡Â»",
  "Â«Ø¥Ù†Ù…Ø§ Ø§Ù„Ø£Ø¹Ù…Ø§Ù„ Ø¨Ø§Ù„Ù†ÙŠØ§ØªØŒ ÙˆØ¥Ù†Ù…Ø§ Ù„ÙƒÙ„ Ø§Ù…Ø±Ø¦ Ù…Ø§ Ù†ÙˆÙ‰Â»",
  "Â«ØªØ¨Ø³Ù…Ùƒ ÙÙŠ ÙˆØ¬Ù‡ Ø£Ø®ÙŠÙƒ Ù„Ùƒ ØµØ¯Ù‚Ø©Â»"
];

const userConfig = {
  'Ù…Ø­Ù…Ø¯': { class: 'av-m', init: 'Ù…' },
  'Ø´ÙŠÙ…Ø§Ø¡': { class: 'av-s', init: 'Ø´' },
  'Ø£Ø­Ù…Ø¯': { class: 'av-a', init: 'Ø£' },
  'ÙŠØ§Ø³ÙŠÙ†': { class: 'av-y', init: 'ÙŠ' }
};

function App(){
  const users = ['Ù…Ø­Ù…Ø¯','Ø´ÙŠÙ…Ø§Ø¡','Ø£Ø­Ù…Ø¯','ÙŠØ§Ø³ÙŠÙ†'];
  const men = ['Ù…Ø­Ù…Ø¯','Ø£Ø­Ù…Ø¯','ÙŠØ§Ø³ÙŠÙ†'];
  const [date, setDate] = useState(new Date().toISOString().split('T')[0]);
  const [data, setData] = useState({});
  const [messages, setMessages] = useState([]);
  const [newMsg, setNewMsg] = useState("");
  const [currentUser, setCurrentUser] = useState("Ù…Ø­Ù…Ø¯");
  const latestData = useRef({});

  // Ù…ÙŠØ²Ø© Ø§Ù„Ø­Ø¯ÙŠØ« Ø§Ù„Ù…ØªØ¬Ø¯Ø¯ ÙŠÙˆÙ…ÙŠØ§Ù‹
  const currentHadith = hadiths[new Date(date).getDate() % hadiths.length];

  useEffect(() => {
    const unsubData = window.onSnapshot(window.docRef, (snap) => {
      if (snap.exists()) { latestData.current = snap.data(); setData(snap.data()); }
    });
    const dailyChatRef = window.docFunc(window.db, "chats", date);
    const unsubChat = window.onSnapshot(dailyChatRef, (snap) => {
      if (snap.exists()) setMessages(snap.data().messages || []);
      else setMessages([]);
    });
    return () => { unsubData(); unsubChat(); };
  }, [date]);

  const update = async (user, task, val) => {
    const newData = { ...latestData.current, [date]: { ...latestData.current[date], [user]: { ...latestData.current[date]?.[user], [task]: val } } };
    await window.setDoc(window.docRef, newData);
  };

  const sendChat = async () => {
    if (!newMsg.trim()) return;
    const dailyChatRef = window.docFunc(window.db, "chats", date);
    await window.setDoc(dailyChatRef, { 
      messages: window.arrayUnion({ user: currentUser, text: newMsg, time: new Date().toLocaleTimeString('ar-EG', {hour:'2-digit', minute:'2-digit'}) }) 
    }, { merge: true });
    setNewMsg("");
  };

  const prayers = ["ØµÙ„Ø§Ø© Ø§Ù„ÙØ¬Ø±", "ØµÙ„Ø§Ø© Ø§Ù„Ø¸Ù‡Ø±", "ØµÙ„Ø§Ø© Ø§Ù„Ø¹ØµØ±", "ØµÙ„Ø§Ø© Ø§Ù„Ù…ØºØ±Ø¨", "ØµÙ„Ø§Ø© Ø§Ù„Ø¹Ø´Ø§Ø¡"];
  const sunan = ["Ø³Ù†Ø© Ø§Ù„ÙØ¬Ø±", "Ø§Ù„Ø¶Ø­Ù‰", "Ø§Ù„ÙˆØ±Ø¯ Ø§Ù„ÙŠÙˆÙ…ÙŠ", "Ø£Ø°ÙƒØ§Ø± Ø§Ù„ØµØ¨Ø§Ø­", "Ø£Ø°ÙƒØ§Ø± Ø§Ù„Ù…Ø³Ø§Ø¡"];

  const dayScores = users.map(u => {
    const dayData = data[date]?.[u] || {};
    let score = 0;
    Object.entries(dayData).forEach(([task, val]) => {
      if (val === true || val === "Ù…Ø³Ø¬Ø¯" || val === "Ø­Ø§Ø¶Ø±") score += 3;
      else if (val === "ÙØ±Ø¯") score += 2;
      else if (val === "Ù‚Ø¶Ø§Ø¡") score += 1;
    });
    const totalTasks = prayers.length + sunan.length;
    const doneCount = Object.values(dayData).filter(v => v).length;
    return { name: u, score, progress: Math.round((doneCount/totalTasks)*100), config: userConfig[u], pending: totalTasks - doneCount };
  }).sort((a,b) => b.score - a.score);

  return (
    <div className="max-w-md mx-auto pb-10">
      <header className="text-center py-6">
        <h1 className="text-3xl font-black text-indigo-900">Ù…Ø­Ø±Ø§Ø¨ Ø§Ù„Ø¹Ø§Ø¦Ù„Ø© ğŸ </h1>
      </header>

      {/* Ø§Ù„Ø­Ø¯ÙŠØ« Ø§Ù„Ø´Ø±ÙŠÙ Ø§Ù„Ù…ØªØ¬Ø¯Ø¯ */}
      <div className="neu-card hadith-card">
        <h3 className="text-[10px] font-bold opacity-80 mb-2 italic">Ø²Ø§Ø¯ Ø§Ù„Ù…Ø³Ù„Ù… Ø§Ù„ÙŠÙˆÙ…ÙŠ âœ¨</h3>
        <p className="text-xl font-bold text-center font-serif leading-relaxed">{currentHadith}</p>
      </div>

      <div className="neu-card p-4 text-center">
        <input type="date" value={date} onChange={e => setDate(e.target.value)} className="neu-inset px-4 py-2 font-bold text-indigo-900 bg-transparent outline-none cursor-pointer"/>
      </div>

      {/* Ù…Ù†ØµØ© Ø§Ù„ØªØªÙˆÙŠØ¬ */}
      <div className="neu-card relative overflow-hidden">
        <h2 className="text-center font-black mb-10 text-indigo-900">ğŸ† Ø£Ø¨Ø·Ø§Ù„ Ø§Ù„ÙŠÙˆÙ…</h2>
        <div className="flex justify-center items-end gap-3 h-48 mb-6 pt-10 border-b border-gray-200">
          <div className="flex flex-col items-center w-1/3">
             <div className={`royal-avatar mb-2 ${dayScores[1]?.config.class}`}>{dayScores[1]?.config.init}</div>
             <div className="podium-2 w-full flex items-center justify-center text-gray-600 font-black text-2xl shadow-inner">2</div>
             <span className="text-[10px] font-bold mt-1">{dayScores[1]?.name}</span>
          </div>
          <div className="flex flex-col items-center w-1/3">
             <span className="text-3xl mb-1 animate-bounce">ğŸ‘‘</span>
             <div className={`royal-avatar mb-2 scale-125 ${dayScores[0]?.config.class}`}>{dayScores[0]?.config.init}</div>
             <div className="podium-1 w-full flex items-center justify-center text-yellow-700 font-black text-4xl shadow-md">1</div>
             <span className="text-[10px] font-black mt-1 text-indigo-900">{dayScores[0]?.name}</span>
          </div>
          <div className="flex flex-col items-center w-1/3">
             <div className={`royal-avatar mb-2 ${dayScores[2]?.config.class}`}>{dayScores[2]?.config.init}</div>
             <div className="podium-3 w-full flex items-center justify-center text-orange-800 font-black text-xl shadow-inner">3</div>
             <span className="text-[10px] font-bold mt-1">{dayScores[2]?.name}</span>
          </div>
        </div>
        
        {/* Ø¹Ø¨Ø§Ø±Ø§Øª Ø§Ù„ØªØ°ÙƒÙŠØ± Ø¨Ø§Ù„Ø¹Ø¨Ø§Ø¯Ø§Øª Ø§Ù„Ù†Ø§Ù‚ØµØ© */}
        <div className="space-y-2 mt-4">
            {dayScores.map(s => s.pending > 0 && (
                <div key={s.name} className="text-[10px] text-gray-500 bg-gray-50 p-2 rounded-lg flex justify-between border-r-4 border-red-300">
                    <span>ÙŠØªØ¨Ù‚Ù‘Ù‰ Ù„Ù€ <b>{s.name}</b> {s.pending} Ø·Ø§Ø¹Ø§Øª Ù„Ø§ÙƒØªÙ…Ø§Ù„ Ø§Ù„ÙŠÙˆÙ…!</span>
                    <span className="font-bold">Ù‡Ù…Ù‘Ø© ÙŠØ§ Ø¨Ø·Ù„! ğŸ’ª</span>
                </div>
            ))}
        </div>
      </div>

      {/* Ø§Ù„Ø¯Ø±Ø¯Ø´Ø© ÙˆØ¹Ø¨Ø§Ø±Ø§Øª Ø§Ù„ØªØ´Ø¬ÙŠØ¹ */}
      <div className="neu-card">
        <h3 className="font-black mb-4 text-indigo-900 border-r-4 border-indigo-500 pr-2 text-sm">Ù…Ø¬Ù„Ø³ Ø§Ù„ØªØ´Ø¬ÙŠØ¹ ğŸ’¬</h3>
        <div className="neu-inset p-3 h-40 overflow-y-auto mb-4 bg-white/50">
          {messages.map((m, i) => (
            <div key={i} className={`mb-2 p-2 rounded-xl text-xs shadow-sm ${m.user === currentUser ? 'bg-indigo-100 mr-8 border-r-2 border-indigo-400' : 'bg-white ml-8 border-l-2 border-gray-300'}`}>
              <div className="flex justify-between font-bold text-[8px] mb-1">
                <span className="text-indigo-600">{m.user}</span>
                <span className="text-gray-400">{m.time}</span>
              </div>
              <p className="text-gray-700 leading-tight">{m.text}</p>
            </div>
          ))}
        </div>
        <div className="flex gap-2">
          <select value={currentUser} onChange={e => setCurrentUser(e.target.value)} className="w-1/4 neu-btn text-[10px] p-2 font-bold outline-none">
            {users.map(u => <option key={u} value={u}>{u}</option>)}
          </select>
          <input value={newMsg} onChange={e => setNewMsg(e.target.value)} onKeyPress={e => e.key === 'Enter' && sendChat()} placeholder="Ø´Ø¬Ø¹ Ø£Ù‡Ù„Ùƒ Ø¨ÙƒÙ„Ù…Ø© Ø·ÙŠØ¨Ø©..." className="flex-1 neu-inset px-3 text-xs outline-none border-none py-2"/>
          <button onClick={sendChat} className="neu-btn px-4 text-indigo-600 font-black text-xl">ğŸš€</button>
        </div>
      </div>

      {/* Ø¬Ø¯ÙˆÙ„ Ø§Ù„Ø¹Ø¨Ø§Ø¯Ø§Øª */}
      <div className="neu-card overflow-x-auto">
        <table className="w-full">
          <thead>
            <tr>
              <th className="py-2 pr-2 text-right text-xs text-gray-400">Ø§Ù„Ø¹Ø¨Ø§Ø¯Ø©</th>
              {users.map(u => (
                <th key={u} className="text-center p-2">
                   <div className={`royal-avatar w-10 h-10 text-xs mx-auto ${userConfig[u].class}`}>{userConfig[u].init}</div>
                   <div className="text-[8px] mt-1 font-bold">{u}</div>
                </th>
              ))}
            </tr>
          </thead>
          <tbody className="divide-y divide-gray-100">
            {prayers.map(p => (
              <tr key={p}>
                <td className="py-3 pr-2 text-right text-[10px] font-bold text-gray-600">{p}</td>
                {users.map(u => (
                  <td key={u} className="text-center px-1">
                    <select value={data[date]?.[u]?.[p] || ""} onChange={e => update(u, p, e.target.value)} className="neu-inset text-[9px] font-bold text-indigo-700 bg-white p-1 outline-none">
                      <option value="">-</option>
                      {men.includes(u) ? <><option value="Ù…Ø³Ø¬Ø¯">ğŸ•Œ</option><option value="ÙØ±Ø¯">ğŸ </option></> : <option value="Ø­Ø§Ø¶Ø±">âœ…</option>}
                      <option value="Ù‚Ø¶Ø§Ø¡">â³</option>
                    </select>
                  </td>
                ))}
              </tr>
            ))}
            {sunan.map(s => (
                <tr key={s}>
                    <td className="py-2 pr-2 text-right text-[9px] text-gray-400">{s}</td>
                    {users.map(u => (
                        <td key={u} className="text-center">
                            <button onClick={() => update(u, s, !data[date]?.[u]?.[s])} className={`w-7 h-7 neu-btn mx-auto flex items-center justify-center ${data[date]?.[u]?.[s] ? 'bg-green-50 shadow-inner' : ''}`}>
                                {data[date]?.[u]?.[s] ? "â­" : ""}
                            </button>
                        </td>
                    ))}
                </tr>
            ))}
          </tbody>
        </table>
      </div>
    </div>
  );
}

const root = ReactDOM.createRoot(document.getElementById('root'));
root.render(<App />);
</script>
</body>
</html>
