<!DOCTYPE html>
<html dir="rtl" lang="ar">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Ø£Ø³Ø±ØªÙŠ Ø¹Ù„Ù‰ Ø§Ù„Ø·Ø§Ø¹Ø© - Ù…Ø­Ù…Ø¯ ÙŠØ§Ø³ÙŠÙ†</title>

<script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
<script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
<script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
<script src="https://cdn.tailwindcss.com"></script>

<style>
@import url('https://fonts.googleapis.com/css2?family=Changa:wght@400;700&display=swap');
body { font-family:'Changa',sans-serif;background:#e0e5ec;padding:15px;color:#444;min-height:100vh }
.neu-flat { background:#e0e5ec; box-shadow:12px 12px 24px #a3b1c6,-12px -12px 24px #fff; border-radius:30px }
.neu-inset { background:#e0e5ec; box-shadow:inset 8px 8px 16px #a3b1c6,inset -8px -8px 16px #fff; border-radius:20px }
.neu-btn { background:#e0e5ec; box-shadow:6px 6px 12px #a3b1c6,-6px -6px 12px #fff; transition:.2s; border-radius:12px }
.neu-btn:active { box-shadow:inset 4px 4px 8px #a3b1c6,inset -4px -4px 8px #fff; transform:scale(.95) }
select{background:transparent;border:none;outline:none;width:100%;font-weight:bold;text-align:center;cursor:pointer}
</style>
</head>

<body>
<div id="root"></div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
import { getFirestore, doc, setDoc, onSnapshot } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

const firebaseConfig = {
  apiKey: "AIzaSyDba3kZK5ibQEIRRjVIHL7JIOHixX_7rVs",
  authDomain: "ebada-656e1.firebaseapp.com",
  projectId: "ebada-656e1",
  storageBucket: "ebada-656e1.firebasestorage.app",
  messagingSenderId: "705608653939",
  appId: "1:705608653939:web:5ab3609a6f7ccc8675de06"
};

const app = initializeApp(firebaseConfig);
const db = getFirestore(app);

// ØªØµØ¯ÙŠØ± Ø§Ù„Ø£Ø¯ÙˆØ§Øª Ù„Ù„Ù†Ø§ÙØ°Ø© Ø§Ù„Ø¹Ø§Ù„Ù…ÙŠØ© Ù„ÙŠØ³ØªØ®Ø¯Ù…Ù‡Ø§ React
window.docRef = doc(db, "worship", "family");
window.setDoc = setDoc;
window.onSnapshot = onSnapshot;
</script>

<script type="text/babel">
const { useState, useEffect, useRef } = React;

function App(){
  const users = ['Ù…Ø­Ù…Ø¯','Ø´ÙŠÙ…Ø§Ø¡','Ø£Ø­Ù…Ø¯','ÙŠØ§Ø³ÙŠÙ†'];
  const men = ['Ù…Ø­Ù…Ø¯','Ø£Ø­Ù…Ø¯','ÙŠØ§Ø³ÙŠÙ†'];
  const [date, setDate] = useState(new Date().toISOString().split('T')[0]);
  const [data, setData] = useState({});
  
  // Ù†Ø³ØªØ®Ø¯Ù… useRef Ù„Ù„Ø§Ø­ØªÙØ§Ø¸ Ø¨Ø£Ø­Ø¯Ø« Ù†Ø³Ø®Ø© Ù…Ù† Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ù„Ù…Ù†Ø¹ Ø§Ù„ÙƒØªØ§Ø¨Ø© ÙÙˆÙ‚ Ø§Ù„ØªØ¹Ø¯ÙŠÙ„Ø§Øª Ø§Ù„Ù…ØªØ²Ø§Ù…Ù†Ø©
  const latestData = useRef({});

  useEffect(() => {
    // Ø§Ù„Ø§ØªØµØ§Ù„ Ø§Ù„Ù„Ø­Ø¸ÙŠ Ø¨Ù€ Firestore
    const unsubscribe = window.onSnapshot(window.docRef, (snap) => {
      if (snap.exists()) {
        const cloudData = snap.data();
        latestData.current = cloudData;
        setData(cloudData);
      }
    });
    return () => unsubscribe();
  }, []);

  // Ø¯Ø§Ù„Ø© Ø§Ù„ØªØ­Ø¯ÙŠØ« Ø§Ù„Ù„Ø­Ø¸ÙŠØ©
  const update = async (user, task, val) => {
    const newData = {
      ...latestData.current,
      [date]: {
        ...latestData.current[date],
        [user]: {
          ...latestData.current[date]?.[user],
          [task]: val
        }
      }
    };

    try {
      // Ø§Ù„Ø­ÙØ¸ ÙÙŠ Firestore Ù…Ø¨Ø§Ø´Ø±Ø©
      await window.setDoc(window.docRef, newData);
    } catch (error) {
      console.error("Ø®Ø·Ø£ ÙÙŠ ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª:", error);
    }
  };

  const isFriday = new Date(date).getDay() === 5;
  const prayers = ["ØµÙ„Ø§Ø© Ø§Ù„ÙØ¬Ø±", isFriday ? "ØµÙ„Ø§Ø© Ø§Ù„Ø¬Ù…Ø¹Ø©" : "ØµÙ„Ø§Ø© Ø§Ù„Ø¸Ù‡Ø±", "ØµÙ„Ø§Ø© Ø§Ù„Ø¹ØµØ±", "ØµÙ„Ø§Ø© Ø§Ù„Ù…ØºØ±Ø¨", "ØµÙ„Ø§Ø© Ø§Ù„Ø¹Ø´Ø§Ø¡"];
  const others = [
    "Ø³Ù†Ø© Ø§Ù„ÙØ¬Ø±", "Ø£Ø°ÙƒØ§Ø± Ø§Ù„ØµØ¨Ø§Ø­", "Ø§Ù„Ø¶Ø­Ù‰", "Ø³ÙˆØ±Ø© Ø§Ù„ÙƒÙ‡Ù", 
    "Ù¤ Ø±ÙƒØ¹Ø§Øª Ù‚Ø¨Ù„ Ø§Ù„Ø¸Ù‡Ø±", "Ø±ÙƒØ¹ØªØ§Ù† Ø¨Ø¹Ø¯ Ø§Ù„Ø¸Ù‡Ø±", "Ø£Ø°ÙƒØ§Ø± Ø§Ù„Ù…Ø³Ø§Ø¡", 
    "Ø±ÙƒØ¹ØªØ§Ù† Ø¨Ø¹Ø¯ Ø§Ù„Ù…ØºØ±Ø¨", "Ø±ÙƒØ¹ØªØ§Ù† Ø¨Ø¹Ø¯ Ø§Ù„Ø¹Ø´Ø§Ø¡", "Ø³ÙˆØ±Ø© Ø§Ù„Ù…Ù„Ùƒ", 
    "Ø§Ù„Ø´ÙØ¹ ÙˆØ§Ù„ÙˆØªØ±", "Ø§Ù„Ù‚ÙŠØ§Ù…", "Ø§Ù„ÙˆØ±Ø¯", "Ø£Ø°ÙƒØ§Ø± Ø§Ù„Ù†ÙˆÙ…"
  ].filter(i => isFriday || i !== "Ø³ÙˆØ±Ø© Ø§Ù„ÙƒÙ‡Ù");

  const scores = users.map(u => ({
    name: u,
    count: Object.values(data[date]?.[u] || {}).filter(v => v && v !== "Ù‚Ø¶Ø§Ø¡").length
  })).sort((a,b) => b.count - a.count);

  return (
    <div className="max-w-md mx-auto space-y-8 pb-10">
      <header className="neu-flat p-8 text-center">
        <h1 className="text-2xl font-bold mb-2">ğŸ  Ø£Ø³Ø±ØªÙŠ Ø¹Ù„Ù‰ Ø§Ù„Ø·Ø§Ø¹Ø©</h1>
        <p className="text-sm text-slate-500 mb-4">Ù…ØªØ§Ø¨Ø¹Ø© Ø§Ù„Ø¹Ø¨Ø§Ø¯Ø§Øª Ø§Ù„ÙŠÙˆÙ…ÙŠØ©</p>
        <div className="neu-inset p-2">
          <input 
            type="date" 
            value={date} 
            onChange={e => setDate(e.target.value)} 
            className="w-full text-center font-bold bg-transparent outline-none border-none"
          />
        </div>
      </header>

      <div className="neu-flat p-4 overflow-x-auto">
        <table className="w-full text-center text-sm">
          <thead>
            <tr>
              <th className="p-2 text-right">Ø§Ù„Ø¹Ø¨Ø§Ø¯Ø©</th>
              {users.map(u => <th key={u} className="p-2">{u}</th>)}
            </tr>
          </thead>
          <tbody>
            {prayers.map(p => (
              <tr key={p} className="border-b border-white/20">
                <td className="text-right font-bold py-4">{p}</td>
                {users.map(u => (
                  <td key={u}>
                    <select 
                      value={data[date]?.[u]?.[p] || ""} 
                      onChange={e => update(u, p, e.target.value)}
                    >
                      <option value="">--</option>
                      {men.includes(u) 
                        ? <><option value="Ù…Ø³Ø¬Ø¯">Ù…Ø³Ø¬Ø¯</option><option value="ÙØ±Ø¯">ÙØ±Ø¯</option></>
                        : <option value="Ø­Ø§Ø¶Ø±">Ø­Ø§Ø¶Ø±</option>
                      }
                      <option value="Ù‚Ø¶Ø§Ø¡">Ù‚Ø¶Ø§Ø¡</option>
                    </select>
                  </td>
                ))}
              </tr>
            ))}
            {others.map(t => (
              <tr key={t} className="border-b border-white/10 text-xs">
                <td className="text-right py-4 text-slate-500">{t}</td>
                {users.map(u => (
                  <td key={u}>
                    <button 
                      onClick={() => update(u, t, !data[date]?.[u]?.[t])}
                      className="w-10 h-10 neu-btn mx-auto flex items-center justify-center"
                    >
                      {data[date]?.[u]?.[t] ? <span className="text-green-600 font-bold">âœ“</span> : ""}
                    </button>
                  </td>
                ))}
              </tr>
            ))}
          </tbody>
        </table>
      </div>

      <div className="neu-flat p-6">
        <h2 className="text-center font-bold mb-4 flex items-center justify-center gap-2">
          ğŸ† Ù„ÙˆØ­Ø© Ø§Ù„Ø´Ø±Ù
        </h2>
        {scores.map((s, i) => (
          <div key={s.name} className="flex justify-between items-center mb-3 p-3 neu-inset">
            <span className="font-bold">{i + 1}. {s.name}</span>
            <span className="bg-blue-500 text-white px-3 py-1 rounded-full text-xs">
              {s.count} Ù†Ù‚Ø·Ø©
            </span>
          </div>
        ))}
      </div>

      <footer className="text-center text-[10px] text-slate-400">
        Ø­Ù‚ÙˆÙ‚ Ø§Ù„ØªØµÙ…ÙŠÙ… Ù…Ø­ÙÙˆØ¸Ø© Â©ï¸ Ù…Ø­Ù…Ø¯ ÙŠØ§Ø³ÙŠÙ† 2026
      </footer>
    </div>
  );
}

const root = ReactDOM.createRoot(document.getElementById('root'));
root.render(<App />);
</script>

</body>
</html>
