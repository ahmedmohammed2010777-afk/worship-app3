<!DOCTYPE html>
<html dir="rtl" lang="ar">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Ø£Ø³Ø±ØªÙŠ Ø¹Ù„Ù‰ Ø§Ù„Ø·Ø§Ø¹Ø© - Ù†Ø³Ø®Ø© Ø§Ù„Ø£Ø¨Ø·Ø§Ù„</title>

<script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
<script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
<script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
<script src="https://cdn.tailwindcss.com"></script>

<style>
@import url('https://fonts.googleapis.com/css2?family=Changa:wght@400;700&display=swap');
body { font-family:'Changa',sans-serif;background:#e0e5ec;padding:10px;color:#444;min-height:100vh }
.neu-card { background:#e0e5ec; box-shadow:9px 9px 16px #a3b1c6, -9px -9px 16px #fff; border-radius:25px; border: 1px solid rgba(255,255,255,0.3) }
.neu-inset { background:#e0e5ec; box-shadow:inset 6px 6px 12px #a3b1c6, inset -6px -6px 12px #fff; border-radius:15px }
.neu-btn { background:#e0e5ec; box-shadow:4px 4px 8px #a3b1c6, -4px -4px 8px #fff; transition:all 0.2s ease; border-radius:10px }
.neu-btn:active { box-shadow:inset 3px 3px 6px #a3b1c6, inset -3px -3px 6px #fff; transform:scale(0.92) }
select { background:transparent; border:none; outline:none; font-weight:bold; cursor:pointer; color: #2563eb; width: 100%; text-align: center; }
.podium-item { transition: all 0.5s ease; position: relative; display: flex; flex-direction: column; align-items: center; justify-content: flex-end; }
</style>
</head>

<body>
<div id="root"></div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
import { getFirestore, doc, setDoc, onSnapshot } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

const firebaseConfig = {
  apiKey: "AIzaSyDba3kZK5ibQEIRRjVIHL7JIOHixX_7rVs",
  authDomain: "ebada-656e1.firebaseapp.com",
  projectId: "ebada-656e1",
  storageBucket: "ebada-656e1.firebasestorage.app",
  messagingSenderId: "705608653939",
  appId: "1:705608653939:web:5ab3609a6f7ccc8675de06"
};

const app = initializeApp(firebaseConfig);
const db = getFirestore(app);
window.docRef = doc(db, "worship", "family");
window.setDoc = setDoc;
window.onSnapshot = onSnapshot;
</script>

<script type="text/babel">
const { useState, useEffect, useRef } = React;

function App(){
  const users = ['Ù…Ø­Ù…Ø¯','Ø´ÙŠÙ…Ø§Ø¡','Ø£Ø­Ù…Ø¯','ÙŠØ§Ø³ÙŠÙ†'];
  const men = ['Ù…Ø­Ù…Ø¯','Ø£Ø­Ù…Ø¯','ÙŠØ§Ø³ÙŠÙ†'];
  const [date, setDate] = useState(new Date().toISOString().split('T')[0]);
  const [data, setData] = useState({});
  const latestData = useRef({});

  useEffect(() => {
    const unsubscribe = window.onSnapshot(window.docRef, (snap) => {
      if (snap.exists()) {
        const cloudData = snap.data();
        latestData.current = cloudData;
        setData(cloudData);
      }
    });
    return () => unsubscribe();
  }, []);

  const update = async (user, task, val) => {
    const newData = {
      ...latestData.current,
      [date]: { ...latestData.current[date], [user]: { ...latestData.current[date]?.[user], [task]: val } }
    };
    try { await window.setDoc(window.docRef, newData); } catch (e) {}
  };

  const isFriday = new Date(date).getDay() === 5;
  const prayers = ["ØµÙ„Ø§Ø© Ø§Ù„ÙØ¬Ø±", isFriday ? "ØµÙ„Ø§Ø© Ø§Ù„Ø¬Ù…Ø¹Ø©" : "ØµÙ„Ø§Ø© Ø§Ù„Ø¸Ù‡Ø±", "ØµÙ„Ø§Ø© Ø§Ù„Ø¹ØµØ±", "ØµÙ„Ø§Ø© Ø§Ù„Ù…ØºØ±Ø¨", "ØµÙ„Ø§Ø© Ø§Ù„Ø¹Ø´Ø§Ø¡"];
  const others = ["Ø³Ù†Ø© Ø§Ù„ÙØ¬Ø±", "Ø£Ø°ÙƒØ§Ø± Ø§Ù„ØµØ¨Ø§Ø­", "Ø§Ù„Ø¶Ø­Ù‰", "Ø³ÙˆØ±Ø© Ø§Ù„ÙƒÙ‡Ù", "Ù¤ Ù‚Ø¨Ù„ Ø§Ù„Ø¸Ù‡Ø±", "Ù¢ Ø¨Ø¹Ø¯ Ø§Ù„Ø¸Ù‡Ø±", "Ø£Ø°ÙƒØ§Ø± Ø§Ù„Ù…Ø³Ø§Ø¡", "Ù¢ Ø¨Ø¹Ø¯ Ø§Ù„Ù…ØºØ±Ø¨", "Ù¢ Ø¨Ø¹Ø¯ Ø§Ù„Ø¹Ø´Ø§Ø¡", "Ø³ÙˆØ±Ø© Ø§Ù„Ù…Ù„Ùƒ", "Ø§Ù„Ø´ÙØ¹ ÙˆØ§Ù„ÙˆØªØ±", "Ø§Ù„Ù‚ÙŠØ§Ù…", "Ø§Ù„ÙˆØ±Ø¯", "Ø£Ø°ÙƒØ§Ø± Ø§Ù„Ù†ÙˆÙ…"].filter(i => isFriday || i !== "Ø³ÙˆØ±Ø© Ø§Ù„ÙƒÙ‡Ù");
  const allTasks = [...prayers, ...others];

  const calculateScore = (user, dayData) => {
    let score = 0;
    if (!dayData?.[user]) return 0;
    Object.entries(dayData[user]).forEach(([task, val]) => {
      if (val === true) score += 3; // Ø§Ù„Ø³Ù†Ù† ÙˆØ§Ù„Ø£Ø°ÙƒØ§Ø±
      else if (val === "Ù…Ø³Ø¬Ø¯" || val === "Ø­Ø§Ø¶Ø±") score += 3;
      else if (val === "ÙØ±Ø¯") score += 2;
      else if (val === "Ù‚Ø¶Ø§Ø¡") score += 1;
    });
    return score;
  };

  const dayScores = users.map(u => {
    const score = calculateScore(u, data[date]);
    const completedCount = Object.values(data[date]?.[u] || {}).filter(v => v).length;
    const progress = Math.round((completedCount / allTasks.length) * 100);
    const missing = allTasks.filter(t => !data[date]?.[u]?.[t]);
    return { name: u, score, progress, missing };
  }).sort((a,b) => b.score - a.score);

  // Ø­Ø³Ø§Ø¨ Ø¨Ø·Ù„ Ø§Ù„Ø´Ù‡Ø±
  const getMonthHero = () => {
    const monthPrefix = date.substring(0, 7); // yyyy-mm
    const monthScores = users.map(u => {
      let total = 0;
      Object.keys(data).filter(d => d.startsWith(monthPrefix)).forEach(d => {
        total += calculateScore(u, data[d]);
      });
      return { name: u, total };
    }).sort((a,b) => b.total - a.total);
    return monthScores[0];
  };

  const hero = getMonthHero();
  const isLastDay = () => {
    const d = new Date(date);
    return new Date(d.getFullYear(), d.getMonth() + 1, 0).getDate() === d.getDate();
  };

  return (
    <div className="max-w-md mx-auto space-y-6 pb-20">
      <header className="neu-card p-6 text-center">
        <h1 className="text-2xl font-bold text-blue-700 mb-4">ğŸ  Ù…Ø­Ø±Ø§Ø¨ Ø¹Ø§Ø¦Ù„Ø© ÙŠØ§Ø³ÙŠÙ†</h1>
        <div className="neu-inset p-1">
          <input type="date" value={date} onChange={e => setDate(e.target.value)} 
            className="w-full text-center font-bold bg-transparent outline-none p-2 text-blue-900"/>
        </div>
      </header>

      {/* Ù…Ù†ØµØ© Ø§Ù„ØªØªÙˆÙŠØ¬ */}
      <div className="neu-card p-6">
        <h2 className="text-center font-bold mb-8 text-slate-600">ğŸ† Ù…Ù†ØµØ© ØªØªÙˆÙŠØ¬ Ø§Ù„Ø£Ø¨Ø·Ø§Ù„</h2>
        <div className="flex justify-center items-end gap-2 h-48">
          {/* Ø§Ù„Ù…Ø±ÙƒØ² Ø§Ù„Ø«Ø§Ù†ÙŠ */}
          <div className="podium-item w-20">
            <span className="text-xs font-bold mb-1">{dayScores[1]?.name}</span>
            <div className="bg-slate-300 w-full rounded-t-lg flex items-center justify-center font-bold text-white shadow-lg" style={{height: '60%'}}>2</div>
          </div>
          {/* Ø§Ù„Ù…Ø±ÙƒØ² Ø§Ù„Ø£ÙˆÙ„ */}
          <div className="podium-item w-24">
            <span className="text-sm font-bold mb-1 text-yellow-600">ğŸ‘‘ {dayScores[0]?.name}</span>
            <div className="bg-yellow-400 w-full rounded-t-lg flex items-center justify-center font-bold text-white shadow-2xl" style={{height: '90%'}}>1</div>
          </div>
          {/* Ø§Ù„Ù…Ø±ÙƒØ² Ø§Ù„Ø«Ø§Ù„Ø« */}
          <div className="podium-item w-20">
            <span className="text-xs font-bold mb-1">{dayScores[2]?.name}</span>
            <div className="bg-orange-400 w-full rounded-t-lg flex items-center justify-center font-bold text-white shadow-md" style={{height: '40%'}}>3</div>
          </div>
        </div>
        
        {/* ØªÙØ§ØµÙŠÙ„ Ø§Ù„Ø¥Ù†Ø¬Ø§Ø² */}
        <div className="mt-8 space-y-4">
          {dayScores.map(s => (
            <div key={s.name} className="neu-inset p-3 text-right">
              <div className="flex justify-between items-center mb-1">
                <span className="font-bold text-blue-800">{s.name}</span>
                <span className="text-xs font-bold text-blue-600">Ø¥Ù†Ø¬Ø§Ø² {s.progress}%</span>
              </div>
              <div className="w-full bg-gray-200 h-1 rounded-full mb-2">
                <div className="bg-blue-500 h-1 rounded-full" style={{width: `${s.progress}%`}}></div>
              </div>
              <p className="text-[9px] text-slate-400 truncate">
                {s.missing.length > 0 ? `Ø¨Ø§Ù†ØªØ¸Ø§Ø±: ${s.missing.join('ØŒ ')}` : "âœ… ØªÙ… Ø§Ù„Ø¥Ù†Ø¬Ø§Ø² ÙƒØ§Ù…Ù„Ø§Ù‹!"}
              </p>
            </div>
          ))}
        </div>
      </div>

      {/* Ø¨Ø·Ù„ Ø§Ù„Ø´Ù‡Ø± */}
      {isLastDay() && (
        <div className="neu-card p-6 bg-gradient-to-br from-yellow-50 to-white border-yellow-200 border-2">
          <h2 className="text-center font-bold text-yellow-700 mb-2">ğŸ… Ø¨Ø·Ù„ Ø§Ù„Ø´Ù‡Ø± Ø§Ù„Ù…ÙˆÙÙ‚</h2>
          <div className="text-center">
            <p className="text-3xl font-black text-yellow-600">{hero.name}</p>
            <p className="text-xs text-yellow-800 mt-2">Ø¨Ø¥Ø¬Ù…Ø§Ù„ÙŠ {hero.total} Ù†Ù‚Ø·Ø© Ø·Ø§Ø¹Ø©</p>
          </div>
        </div>
      )}

      {/* Ø¬Ø¯ÙˆÙ„ Ø§Ù„Ø¹Ø¨Ø§Ø¯Ø§Øª */}
      <div className="neu-card p-4 overflow-x-auto">
        <table className="w-full">
          <thead>
            <tr>
              <th className="text-right text-[10px] text-blue-900 pb-2">Ø§Ù„Ø¹Ø¨Ø§Ø¯Ø©</th>
              {users.map(u => <th key={u} className="text-[10px] pb-2">{u}</th>)}
            </tr>
          </thead>
          <tbody>
            {prayers.map(p => (
              <tr key={p} className="border-b border-white/20">
                <td className="py-3 text-[10px] font-bold text-slate-600">{p}</td>
                {users.map(u => (
                  <td key={u} className="px-1">
                    <div className="neu-inset p-1">
                      <select value={data[date]?.[u]?.[p] || ""} onChange={e => update(u, p, e.target.value)}>
                        <option value="">--</option>
                        {men.includes(u) ? <><option value="Ù…Ø³Ø¬Ø¯">ğŸ•Œ</option><option value="ÙØ±Ø¯">ğŸ </option></> : <option value="Ø­Ø§Ø¶Ø±">âœ…</option>}
                        <option value="Ù‚Ø¶Ø§Ø¡">â³</option>
                      </select>
                    </div>
                  </td>
                ))}
              </tr>
            ))}
            {others.map(t => (
              <tr key={t} className="border-b border-white/10">
                <td className="py-2 text-[9px] text-slate-500">{t}</td>
                {users.map(u => (
                  <td key={u} className="text-center">
                    <button onClick={() => update(u, t, !data[date]?.[u]?.[t])}
                      className="w-7 h-7 neu-btn mx-auto flex items-center justify-center text-[10px]">
                      {data[date]?.[u]?.[t] ? "âœ”ï¸" : ""}
                    </button>
                  </td>
                ))}
              </tr>
            ))}
          </tbody>
        </table>
      </div>
    </div>
  );
}

const root = ReactDOM.createRoot(document.getElementById('root'));
root.render(<App />);
</script>
</body>
</html>
