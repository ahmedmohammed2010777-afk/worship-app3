<!DOCTYPE html>
<html dir="rtl" lang="ar">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Ø£Ø³Ø±ØªÙŠ Ø¹Ù„Ù‰ Ø§Ù„Ø·Ø§Ø¹Ø©</title>

<script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
<script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
<script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
<script src="https://cdn.tailwindcss.com"></script>

<style>
@import url('https://fonts.googleapis.com/css2?family=Changa:wght@400;700&family=Amiri:wght@700&display=swap');
body { font-family:'Changa',sans-serif;background:#e0e5ec;padding:10px;color:#444;min-height:100vh }
.neu-card { background:#e0e5ec; box-shadow:9px 9px 16px #a3b1c6, -9px -9px 16px #fff; border-radius:25px; border: 1px solid rgba(255,255,255,0.3); margin-bottom: 20px; }
.neu-inset { background:#e0e5ec; box-shadow:inset 6px 6px 12px #a3b1c6, inset -6px -6px 12px #fff; border-radius:15px }
.neu-btn { background:#e0e5ec; box-shadow:4px 4px 8px #a3b1c6, -4px -4px 8px #fff; transition:all 0.2s ease; border-radius:10px }
.neu-btn:active { box-shadow:inset 3px 3px 6px #a3b1c6, inset -3px -3px 6px #fff; transform:scale(0.92) }
.hadith-card { background: linear-gradient(135deg, #fdfbfb 0%, #ebedee 100%); border-right: 5px solid #fbbf24; }
.chat-msg { margin-bottom: 8px; padding: 8px 12px; border-radius: 15px; font-size: 13px; line-height: 1.4; }
.podium-avatar { width: 65px; height: 65px; border-radius: 50%; border: 4px solid white; margin-bottom: -10px; z-index: 10; object-fit: cover; background: #eee; box-shadow: 0 4px 10px rgba(0,0,0,0.2); }
.trophy-1 { font-size: 45px; filter: drop-shadow(0 0 10px #fbbf24); position: absolute; top: -40px; }
</style>
</head>

<body>
<div id="root"></div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
import { getFirestore, doc, setDoc, onSnapshot, arrayUnion } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

const firebaseConfig = {
  apiKey: "AIzaSyDba3kZK5ibQEIRRjVIHL7JIOHixX_7rVs",
  authDomain: "ebada-656e1.firebaseapp.com",
  projectId: "ebada-656e1",
  storageBucket: "ebada-656e1.firebasestorage.app",
  messagingSenderId: "705608653939",
  appId: "1:705608653939:web:5ab3609a6f7ccc8675de06"
};

const app = initializeApp(firebaseConfig);
const db = getFirestore(app);
window.docRef = doc(db, "worship", "family");
window.db = db;
window.setDoc = setDoc;
window.onSnapshot = onSnapshot;
window.arrayUnion = arrayUnion;
window.docFunc = doc;
</script>

<script type="text/babel">
const { useState, useEffect, useRef } = React;

const hadiths = [
  "Â«Ø®ÙŠØ§Ø±ÙƒÙ… Ø®ÙŠØ§Ø±ÙƒÙ… Ù„Ø£Ù‡Ù„Ù‡Ù…Â»",
  "Â«Ø£Ø­Ø¨ Ø§Ù„Ø£Ø¹Ù…Ø§Ù„ Ø¥Ù„Ù‰ Ø§Ù„Ù„Ù‡ Ø£Ø¯ÙˆÙ…Ù‡Ø§ ÙˆØ¥Ù† Ù‚Ù„Â»",
  "Â«Ù…Ù† Ø³Ù„Ùƒ Ø·Ø±ÙŠÙ‚Ø§Ù‹ ÙŠÙ„ØªÙ…Ø³ ÙÙŠÙ‡ Ø¹Ù„Ù…Ø§Ù‹ Ø³Ù‡Ù„ Ø§Ù„Ù„Ù‡ Ù„Ù‡ Ø·Ø±ÙŠÙ‚Ø§Ù‹ Ø¥Ù„Ù‰ Ø§Ù„Ø¬Ù†Ø©Â»",
  "Â«ÙƒÙ„Ù…ØªØ§Ù† Ø®ÙÙŠÙØªØ§Ù† Ø¹Ù„Ù‰ Ø§Ù„Ù„Ø³Ø§Ù†ØŒ Ø«Ù‚ÙŠÙ„ØªØ§Ù† ÙÙŠ Ø§Ù„Ù…ÙŠØ²Ø§Ù†: Ø³Ø¨Ø­Ø§Ù† Ø§Ù„Ù„Ù‡ ÙˆØ¨Ø­Ù…Ø¯Ù‡Â»",
  "Â«Ø®ÙŠØ±ÙƒÙ… Ù…Ù† ØªØ¹Ù„Ù… Ø§Ù„Ù‚Ø±Ø¢Ù† ÙˆØ¹Ù„Ù…Ù‡Â»",
  "Â«Ø¥Ù†Ù…Ø§ Ø§Ù„Ø£Ø¹Ù…Ø§Ù„ Ø¨Ø§Ù„Ù†ÙŠØ§ØªØŒ ÙˆØ¥Ù†Ù…Ø§ Ù„ÙƒÙ„ Ø§Ù…Ø±Ø¦ Ù…Ø§ Ù†ÙˆÙ‰Â»",
  "Â«Ø§Ù„Ù…Ø¤Ù…Ù† Ø§Ù„Ù‚ÙˆÙŠ Ø®ÙŠØ± ÙˆØ£Ø­Ø¨ Ø¥Ù„Ù‰ Ø§Ù„Ù„Ù‡ Ù…Ù† Ø§Ù„Ù…Ø¤Ù…Ù† Ø§Ù„Ø¶Ø¹ÙŠÙÂ»",
  "Â«ØªØ¨Ø³Ù…Ùƒ ÙÙŠ ÙˆØ¬Ù‡ Ø£Ø®ÙŠÙƒ Ù„Ùƒ ØµØ¯Ù‚Ø©Â»",
  "Â«Ù…Ù† ÙƒØ§Ù† ÙŠØ¤Ù…Ù† Ø¨Ø§Ù„Ù„Ù‡ ÙˆØ§Ù„ÙŠÙˆÙ… Ø§Ù„Ø¢Ø®Ø± ÙÙ„ÙŠÙ‚Ù„ Ø®ÙŠØ±Ø§Ù‹ Ø£Ùˆ Ù„ÙŠØµÙ…ØªÂ»",
  "Â«Ù„Ø§ ÙŠØ¤Ù…Ù† Ø£Ø­Ø¯ÙƒÙ… Ø­ØªÙ‰ ÙŠØ­Ø¨ Ù„Ø£Ø®ÙŠÙ‡ Ù…Ø§ ÙŠØ­Ø¨ Ù„Ù†ÙØ³Ù‡Â»",
  "Â«Ø§ØªÙ‚ Ø§Ù„Ù„Ù‡ Ø­ÙŠØ«Ù…Ø§ ÙƒÙ†ØªØŒ ÙˆØ£ØªØ¨Ø¹ Ø§Ù„Ø³ÙŠØ¦Ø© Ø§Ù„Ø­Ø³Ù†Ø© ØªÙ…Ø­Ù‡Ø§Â»",
  "Â«Ø§Ù„Ø¯ÙŠÙ† Ø§Ù„Ù†ØµÙŠØ­Ø©Â»"
];

// Ø§Ù„ØµÙˆØ± Ø§Ù„Ø­Ù‚ÙŠÙ‚ÙŠØ© Ù„Ù„Ø¹Ø§Ø¦Ù„Ø© Ø¨Ø§Ù„ÙƒØ§Ù…Ù„
const userImages = {
  'Ù…Ø­Ù…Ø¯': 'https://r2.erweima.ai/i/6f966020-22c6-48c4-8b65-680f4f9f4b9c.png',
  'Ø£Ø­Ù…Ø¯': 'https://r2.erweima.ai/i/0689626e-440a-4074-b81b-53531b402e90.png',
  'ÙŠØ§Ø³ÙŠÙ†': 'https://r2.erweima.ai/i/f3265538-4e8c-4f51-b8f4-600320696700.png',
  'Ø´ÙŠÙ…Ø§Ø¡': 'https://r2.erweima.ai/i/e0210f8a-466d-472d-94c0-7f212f45811f.png'
};

function App(){
  const users = ['Ù…Ø­Ù…Ø¯','Ø´ÙŠÙ…Ø§Ø¡','Ø£Ø­Ù…Ø¯','ÙŠØ§Ø³ÙŠÙ†'];
  const men = ['Ù…Ø­Ù…Ø¯','Ø£Ø­Ù…Ø¯','ÙŠØ§Ø³ÙŠÙ†'];
  const [date, setDate] = useState(new Date().toISOString().split('T')[0]);
  const [data, setData] = useState({});
  const [messages, setMessages] = useState([]);
  const [newMsg, setNewMsg] = useState("");
  const [currentUser, setCurrentUser] = useState("Ù…Ø­Ù…Ø¯");
  const latestData = useRef({});

  const currentHadith = hadiths[new Date(date).getDate() % hadiths.length];

  useEffect(() => {
    const unsubData = window.onSnapshot(window.docRef, (snap) => {
      if (snap.exists()) { latestData.current = snap.data(); setData(snap.data()); }
    });
    const dailyChatRef = window.docFunc(window.db, "chats", date);
    const unsubChat = window.onSnapshot(dailyChatRef, (snap) => {
      if (snap.exists()) setMessages(snap.data().messages || []);
      else setMessages([]);
    });
    return () => { unsubData(); unsubChat(); };
  }, [date]);

  const sendChat = async () => {
    if (!newMsg.trim()) return;
    const dailyChatRef = window.docFunc(window.db, "chats", date);
    await window.setDoc(dailyChatRef, { 
      messages: window.arrayUnion({ user: currentUser, text: newMsg, time: new Date().toLocaleTimeString('ar-EG', {hour:'2-digit', minute:'2-digit'}) }) 
    }, { merge: true });
    setNewMsg("");
  };

  const update = async (user, task, val) => {
    const newData = { ...latestData.current, [date]: { ...latestData.current[date], [user]: { ...latestData.current[date]?.[user], [task]: val } } };
    await window.setDoc(window.docRef, newData);
  };

  const isFriday = new Date(date).getDay() === 5;
  const prayers = ["ØµÙ„Ø§Ø© Ø§Ù„ÙØ¬Ø±", isFriday ? "ØµÙ„Ø§Ø© Ø§Ù„Ø¬Ù…Ø¹Ø©" : "ØµÙ„Ø§Ø© Ø§Ù„Ø¸Ù‡Ø±", "ØµÙ„Ø§Ø© Ø§Ù„Ø¹ØµØ±", "ØµÙ„Ø§Ø© Ø§Ù„Ù…ØºØ±Ø¨", "ØµÙ„Ø§Ø© Ø§Ù„Ø¹Ø´Ø§Ø¡"];
  const others = ["Ø³Ù†Ø© Ø§Ù„ÙØ¬Ø±", "Ø£Ø°ÙƒØ§Ø± Ø§Ù„ØµØ¨Ø§Ø­", "Ø§Ù„Ø¶Ø­Ù‰", "Ø³ÙˆØ±Ø© Ø§Ù„ÙƒÙ‡Ù", "Ù¤ Ù‚Ø¨Ù„ Ø§Ù„Ø¸Ù‡Ø±", "Ù¢ Ø¨Ø¹Ø¯ Ø§Ù„Ø¸Ù‡Ø±", "Ø£Ø°ÙƒØ§Ø± Ø§Ù„Ù…Ø³Ø§Ø¡", "Ù¢ Ø¨Ø¹Ø¯ Ø§Ù„Ù…ØºØ±Ø¨", "Ù¢ Ø¨Ø¹Ø¯ Ø§Ù„Ø¹Ø´Ø§Ø¡", "Ø³ÙˆØ±Ø© Ø§Ù„Ù…Ù„Ùƒ", "Ø§Ù„Ø´ÙØ¹ ÙˆØ§Ù„ÙˆØªØ±", "Ø§Ù„Ù‚ÙŠØ§Ù…", "Ø§Ù„ÙˆØ±Ø¯", "Ø£Ø°ÙƒØ§Ø± Ø§Ù„Ù†ÙˆÙ…"].filter(i => isFriday || i !== "Ø³ÙˆØ±Ø© Ø§Ù„ÙƒÙ‡Ù");
  
  const dayScores = users.map(u => {
    const dayData = data[date]?.[u] || {};
    let score = 0;
    Object.entries(dayData).forEach(([task, val]) => {
      if (val === true || val === "Ù…Ø³Ø¬Ø¯" || val === "Ø­Ø§Ø¶Ø±") score += 3;
      else if (val === "ÙØ±Ø¯") score += 2;
      else if (val === "Ù‚Ø¶Ø§Ø¡") score += 1;
    });
    const doneCount = Object.values(dayData).filter(v => v).length;
    const progress = Math.round((doneCount / (prayers.length + others.length)) * 100);
    const missing = [...prayers, ...others].filter(t => !dayData[t]);
    return { name: u, score, progress, missing, img: userImages[u] };
  }).sort((a,b) => b.score - a.score);

  return (
    <div className="max-w-md mx-auto pb-10">
      <header className="text-center py-6">
        <h1 className="text-3xl font-black text-blue-900 drop-shadow-sm">Ø£Ø³Ø±ØªÙŠ Ø¹Ù„Ù‰ Ø§Ù„Ø·Ø§Ø¹Ø©</h1>
      </header>

      {/* Ø§Ù„Ø­Ø¯ÙŠØ« Ø§Ù„ÙŠÙˆÙ…ÙŠ */}
      <div className="neu-card hadith-card p-6 mb-6">
        <h3 className="text-yellow-600 font-bold text-[10px] mb-2 border-b border-yellow-200 inline-block uppercase tracking-widest">Ø­Ø¯ÙŠØ« Ø§Ù„ÙŠÙˆÙ…</h3>
        <p className="text-xl font-bold text-slate-800 leading-relaxed text-center font-serif">{currentHadith}</p>
      </div>

      <div className="neu-card p-4 mb-6">
        <div className="neu-inset p-1">
          <input type="date" value={date} onChange={e => setDate(e.target.value)} className="w-full text-center font-bold bg-transparent outline-none p-2 text-blue-900 cursor-pointer"/>
        </div>
      </div>

      {/* Ù…Ù†ØµØ© Ø§Ù„ØªØªÙˆÙŠØ¬ Ø¨Ø§Ù„Ø¹Ø§Ø¦Ù„Ø© */}
      <div className="neu-card p-6 shadow-xl relative">
        <h2 className="text-center font-bold mb-12 text-slate-500">ğŸ† Ù„ÙˆØ­Ø© Ø§Ù„Ø´Ø±Ù Ø§Ù„ÙŠÙˆÙ…ÙŠØ©</h2>
        <div className="flex justify-center items-end gap-2 h-64 border-b-2 border-white/50 mb-8 pt-10">
          <div className="flex flex-col items-center w-1/3">
            <img src={dayScores[1]?.img} className="podium-avatar border-slate-300 shadow-lg" />
            <span className="text-[10px] font-bold mb-1">ğŸ¥ˆ {dayScores[1]?.name}</span>
            <div className="bg-slate-300 w-full rounded-t-lg shadow-lg flex items-center justify-center text-white font-bold" style={{height: '75px'}}>2</div>
          </div>
          <div className="flex flex-col items-center w-1/3 relative">
            <span className="trophy-1 animate-bounce">ğŸ†</span>
            <img src={dayScores[0]?.img} className="podium-avatar border-yellow-400 scale-125 shadow-xl" />
            <span className="text-xs font-bold mb-1 text-yellow-600">ğŸ¥‡ {dayScores[0]?.name}</span>
            <div className="bg-yellow-400 w-full rounded-t-lg shadow-2xl flex items-center justify-center text-white font-black" style={{height: '120px'}}>1</div>
          </div>
          <div className="flex flex-col items-center w-1/3">
            <img src={dayScores[2]?.img} className="podium-avatar border-orange-400 shadow-md" />
            <span className="text-[10px] font-bold mb-1">ğŸ¥‰ {dayScores[2]?.name}</span>
            <div className="bg-orange-400 w-full rounded-t-lg shadow-md flex items-center justify-center text-white font-bold" style={{height: '45px'}}>3</div>
          </div>
        </div>

        <div className="space-y-4">
          {dayScores.map(s => (
            <div key={s.name} className="neu-inset p-3 flex items-center gap-3">
              <img src={s.img} className="w-12 h-12 rounded-full border-2 border-white shadow-sm object-cover" />
              <div className="flex-1">
                <div className="flex justify-between items-center mb-1 text-xs font-bold text-slate-700">
                  <span>{s.name}</span>
                  <span className="text-blue-600 font-black">{s.progress}%</span>
                </div>
                <div className="w-full bg-gray-200 h-2 rounded-full overflow-hidden">
                  <div className="bg-blue-500 h-full transition-all duration-1000" style={{width: `${s.progress}%`}}></div>
                </div>
                <p className="text-[9px] mt-1 text-slate-500 leading-tight italic">
                   {s.missing.length > 0 ? <span className="text-red-400 font-medium">Ø¨Ø§Ù†ØªØ¸Ø§Ø±: {s.missing.slice(0,2).join('ØŒ ')}...</span> : <span className="text-green-500 font-bold">âœ¨ Ø¨Ø·Ù„ Ø§Ù„ÙŠÙˆÙ…!</span>}
                </p>
              </div>
            </div>
          ))}
        </div>
      </div>

      {/* Ø¯Ø±Ø¯Ø´Ø© Ø§Ù„ÙŠÙˆÙ… */}
      <div className="neu-card p-4 shadow-lg border-t-4 border-blue-400">
        <h3 className="text-center font-bold mb-4 text-blue-800">ğŸ’¬ Ù…Ù„ØªÙ‚Ù‰ Ø§Ù„Ø¹Ø§Ø¦Ù„Ø© Ø§Ù„ÙŠÙˆÙ…ÙŠ</h3>
        <div className="neu-inset p-3 h-48 overflow-y-auto mb-4 bg-white/10">
          {messages.map((m, i) => (
            <div key={i} className={`chat-msg ${m.user === currentUser ? 'mr-auto bg-blue-100 border-r-4 border-blue-300' : 'ml-auto bg-white border-l-4 border-gray-300'} shadow-sm flex items-start gap-2 max-w-[90%]`}>
              <img src={userImages[m.user]} className="w-7 h-7 rounded-full shadow-sm object-cover" />
              <div>
                <div className="flex justify-between gap-4">
                  <span className="font-bold text-[9px] text-blue-600">{m.user}</span>
                  <span className="text-[7px] text-gray-400">{m.time}</span>
                </div>
                <p className="text-xs text-slate-700 font-medium">{m.text}</p>
              </div>
            </div>
          ))}
        </div>
        <div className="flex gap-2">
          <select value={currentUser} onChange={e => setCurrentUser(e.target.value)} className="w-1/4 neu-btn text-[10px] font-bold p-1">
            {users.map(u => <option key={u} value={u}>{u}</option>)}
          </select>
          <input value={newMsg} onChange={e => setNewMsg(e.target.value)} onKeyPress={e => e.key === 'Enter' && sendChat()} placeholder="Ø§ÙƒØªØ¨ Ø±Ø³Ø§Ù„Ø© ØªØ´Ø¬ÙŠØ¹..." className="flex-1 neu-inset px-3 text-sm outline-none border-none"/>
          <button onClick={sendChat} className="neu-btn px-4 py-2 font-bold text-blue-600">Ø§Ø±Ø³Ù„</button>
        </div>
      </div>

      {/* Ø§Ù„Ø¬Ø¯ÙˆÙ„ */}
      <div className="neu-card p-4 overflow-x-auto mt-6 shadow-inner">
        <table className="w-full">
          <thead>
            <tr>
              <th className="text-right text-[10px] text-blue-900 pb-3 font-black">Ø§Ù„Ø¹Ø¨Ø§Ø¯Ø©</th>
              {users.map(u => (
                <th key={u} className="text-[9px] pb-3 text-center">
                  <img src={userImages[u]} className="w-8 h-8 rounded-full mx-auto mb-1 border shadow-sm object-cover" />
                  {u}
                </th>
              ))}
            </tr>
          </thead>
          <tbody>
            {prayers.map(p => (
              <tr key={p} className="border-b border-white/20">
                <td className="py-3 text-right text-[10px] font-bold text-slate-600">{p}</td>
                {users.map(u => (
                  <td key={u} className="px-1 text-center">
                    <div className="neu-inset p-1">
                      <select value={data[date]?.[u]?.[p] || ""} onChange={e => update(u, p, e.target.value)} className="text-[10px] font-bold text-blue-700 bg-transparent">
                        <option value="">--</option>
                        {men.includes(u) ? <><option value="Ù…Ø³Ø¬Ø¯">ğŸ•Œ</option><option value="ÙØ±Ø¯">ğŸ </option></> : <option value="Ø­Ø§Ø¶Ø±">âœ…</option>}
                        <option value="Ù‚Ø¶Ø§Ø¡">â³</option>
                      </select>
                    </div>
                  </td>
                ))}
              </tr>
            ))}
            {others.map(t => (
              <tr key={t} className="border-b border-white/10">
                <td className="py-2 text-right text-[9px] text-slate-500">{t}</td>
                {users.map(u => (
                  <td key={u} className="text-center px-1">
                    <button onClick={() => update(u, t, !data[date]?.[u]?.[t])} className="w-7 h-7 neu-btn mx-auto flex items-center justify-center text-[12px]">
                      {data[date]?.[u]?.[t] ? "âœ”ï¸" : ""}
                    </button>
                  </td>
                ))}
              </tr>
            ))}
          </tbody>
        </table>
      </div>
    </div>
  );
}

const root = ReactDOM.createRoot(document.getElementById('root'));
root.render(<App />);
</script>
</body>
</html>
