<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ù…Ø­Ø±Ø§Ø¨ Ø¹Ø§Ø¦Ù„ØªÙŠ 2026 - Ø§Ù„Ù†Ø³Ø®Ø© Ø§Ù„ÙƒØ§Ù…Ù„Ø©</title>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Amiri:wght@400;700&family=Tajawal:wght@400;700&display=swap" rel="stylesheet">
    <style>
        :root { --gold: #b8860b; --emerald: #2e7d32; --dark-red: #d32f2f; --wa-green: #075e54; --wa-light: #dcf8c6; --soft-bg: #f4f7f6; }
        body { font-family: 'Tajawal', sans-serif; background-color: var(--soft-bg); margin: 0; padding: 10px; direction: rtl; }
        .container { max-width: 900px; margin: 0 auto; }
        .app-header { text-align: center; color: var(--wa-green); margin-bottom: 10px; }
        .calendar-picker { margin-bottom: 15px; text-align: center; }
        #main-calendar { padding: 8px; border-radius: 10px; border: 2px solid var(--gold); font-family: 'Tajawal'; cursor: pointer; }
        .luxury-card { background: white; border-radius: 20px; padding: 15px; margin-bottom: 15px; border: 1px solid rgba(184, 134, 11, 0.3); box-shadow: 0 4px 15px rgba(0,0,0,0.05); }
        .card-inner { border: 2px double var(--gold); border-radius: 15px; padding: 15px; text-align: center; }
        .naskh { font-family: 'Amiri', serif; font-size: 1.3rem; font-weight: bold; line-height: 1.6; }
        .family-selector { display: flex; justify-content: center; gap: 8px; margin-bottom: 15px; flex-wrap: wrap; }
        .user-btn { padding: 8px 15px; border-radius: 20px; border: 2px solid var(--wa-green); background: white; cursor: pointer; font-weight: bold; }
        .user-btn.active { background: var(--wa-green); color: white; }
        .podium-flex { display: flex; align-items: flex-end; justify-content: center; gap: 5px; height: 230px; margin-top: 30px; }
        .podium-step { flex: 1; display: flex; flex-direction: column; align-items: center; border-radius: 12px 12px 0 0; position: relative; padding-bottom: 10px; background: #eee; transition: 0.5s; min-width: 70px; }
        .step-1 { background: linear-gradient(to top, #ffd700, #fff); height: 100%; border: 1px solid var(--gold); }
        .step-2 { background: linear-gradient(to top, #c0c0c0, #fff); height: 80%; }
        .step-3 { background: linear-gradient(to top, #cd7f32, #fff); height: 65%; }
        .medal { position: absolute; top: -30px; font-size: 1.5rem; }
        .remain-box { font-size: 0.6rem; color: var(--dark-red); background: white; padding: 3px; border-radius: 5px; width: 90%; margin-top: 5px; border: 1px dashed #ccc; overflow: hidden; }
        .section-box { background: white; border-radius: 15px; padding: 15px; margin-bottom: 15px; }
        .section-title { border-right: 5px solid var(--wa-green); padding-right: 10px; color: var(--wa-green); font-weight: bold; margin-bottom: 10px; }
        .task-row { display: flex; align-items: center; justify-content: space-between; padding: 10px 0; border-bottom: 1px solid #f9f9f9; }
        .badge { font-size: 0.7rem; padding: 2px 6px; border-radius: 8px; background: #e8f5e9; color: var(--emerald); border: 1px solid #c8e6c9; }
        .opt-btn { font-size: 0.7rem; padding: 5px 8px; border-radius: 5px; border: 1px solid #ddd; cursor: pointer; background: white; }
        .opt-btn.active-masjid { background: var(--emerald); color: white; }
        .opt-btn.active-fard { background: #2196F3; color: white; }
        .ext-link { color: var(--wa-green); text-decoration: none; font-weight: bold; border-bottom: 1px solid; font-size: 0.8rem; }
        .chat-section { background: #e5ddd5; border-radius: 20px; overflow: hidden; margin-top: 20px; border: 1px solid #ccc; }
        .chat-messages { height: 250px; overflow-y: auto; padding: 10px; display: flex; flex-direction: column; gap: 8px; }
        .msg { max-width: 80%; padding: 8px; border-radius: 10px; font-size: 0.9rem; box-shadow: 0 1px 1px rgba(0,0,0,0.1); }
        .msg-sent { background: var(--wa-light); align-self: flex-end; }
        .msg-received { background: white; align-self: flex-start; }
    </style>
</head>
<body>
<div class="container">
    <div class="app-header">
        <h1>ğŸ•Œ Ù…Ø­Ø±Ø§Ø¨ Ø¹Ø§Ø¦Ù„ØªÙŠ</h1>
        <div class="calendar-picker">
            <input type="date" id="main-calendar" onchange="init()">
        </div>
        <h2 id="display-date" style="color: var(--gold);"></h2>
    </div>
    
    <div id="spiritual-header"></div>
    
    <div class="family-selector" id="user-btns"></div>
    
    <div class="luxury-card">
        <h3 style="text-align:center; color: var(--wa-green); margin:0;">ğŸ† Ø­ØµØ§Ø¯ Ø§Ù„Ø·Ø§Ø¹Ø§Øª ÙˆØ§Ù„ØªØ±ØªÙŠØ¨</h3>
        <div class="podium-flex" id="podium-ui"></div>
    </div>

    <div id="tasks-area">
        <div class="section-box"><h3 class="section-title">Ø§Ù„ÙØ±ÙˆØ¶ Ø§Ù„Ø®Ù…Ø³Ø©</h3><div id="fard-list"></div></div>
        <div class="section-box"><h3 class="section-title">Ø§Ù„Ø³Ù†Ù† Ø§Ù„Ø±ÙˆØ§ØªØ¨</h3><div id="sunnah-list"></div></div>
        <div class="section-box"><h3 class="section-title">Ø§Ù„Ø£Ø°ÙƒØ§Ø± ÙˆØ§Ù„Ø£ÙˆØ±Ø§Ø¯ (Ø±ÙˆØ§Ø¨Ø· Ø®Ø§Ø±Ø¬ÙŠØ©)</h3><div id="words-list"></div></div>
    </div>

    <div class="chat-section">
        <div style="background:var(--wa-green);color:white;padding:10px;text-align:center;font-weight:bold;">ğŸ’¬ Ù…Ù„ØªÙ‚Ù‰ Ø§Ù„Ø¹Ø§Ø¦Ù„Ø© (ÙŠØªØ¬Ø¯Ø¯ ÙŠÙˆÙ…ÙŠØ§Ù‹)</div>
        <div class="chat-messages" id="chat-box"></div>
        <div style="padding:10px; display:flex; gap:5px; background:#f0f0f0">
            <input type="text" id="chat-input" style="flex:1; padding:10px; border-radius:20px; border:1px solid #ccc; outline:none;" placeholder="Ø§ÙƒØªØ¨ Ø±Ø³Ø§Ù„Ø© Ù„Ù‡Ø°Ø§ Ø§Ù„ÙŠÙˆÙ…...">
            <button onclick="sendMessage()" style="background:var(--wa-green);color:white;border:none;padding:0 20px;border-radius:20px;cursor:pointer;">Ø¥Ø±Ø³Ø§Ù„</button>
        </div>
    </div>
</div>

<script>
    const firebaseConfig = {
        apiKey: "AIzaSyC07056086539395ab3609a6f7ccc8675de06",
        databaseURL: "https://ebada-656e1-default-rtdb.firebaseio.com",
        projectId: "ebada-656e1",
        appId: "1:705608653939:web:5ab3609a6f7ccc8675de06"
    };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.database();

    // Ù‚Ø§Ø¹Ø¯Ø© Ø¨ÙŠØ§Ù†Ø§Øª Ø¶Ø®Ù…Ø© (ØªÙ… Ø§Ø³ØªØ®Ø¯Ø§Ù… Ù…Ø­Ø±Ùƒ Ø±ÙŠØ§Ø¶ÙŠ Ù„Ø§Ø®ØªÙŠØ§Ø± ÙØ±ÙŠØ¯ Ù„ÙƒÙ„ ÙŠÙˆÙ… Ù…Ù† 366 ÙŠÙˆÙ…)
    const library = {
        hadiths: [
            "Ù‚Ø§Ù„ ï·º: Ø®ÙÙŠÙ’Ø±ÙÙƒÙÙ…Ù’ Ù…ÙÙ†Ù’ ØªÙØ¹ÙÙ„Ù‘ÙÙ…Ù Ø§Ù„Ù’Ù‚ÙØ±Ù’Ø¢Ù†Ù ÙˆÙØ¹ÙÙ„Ù‘ÙÙ…ÙÙ‡Ù", "Ù‚Ø§Ù„ ï·º: Ø£ÙØ­ÙØ¨Ù‘Ù Ø§Ù„Ø£ÙØ¹Ù’Ù…ÙØ§Ù„Ù Ø¥ÙÙ„ÙÙ‰ Ø§Ù„Ù„Ù‘ÙÙ‡Ù Ø£ÙØ¯Ù’ÙˆÙÙ…ÙÙ‡ÙØ§ ÙˆÙØ¥ÙÙ†Ù’ Ù‚ÙÙ„Ù‘Ù", 
            "Ù‚Ø§Ù„ ï·º: Ù…ÙÙ†Ù’ ØµÙÙ„Ù‘ÙÙ‰ ÙÙÙŠ ÙŠÙÙˆÙ’Ù…Ù Ø«ÙÙ†Ù’ØªÙÙŠÙ’ Ø¹ÙØ´Ù’Ø±ÙØ©Ù Ø±ÙÙƒÙ’Ø¹ÙØ©Ù‹ Ø¨ÙÙ†ÙÙŠÙ Ù„ÙÙ‡Ù Ø¨ÙÙŠÙ’ØªÙŒ ÙÙÙŠ Ø§Ù„Ù’Ø¬ÙÙ†Ù‘ÙØ©Ù", "Ù‚Ø§Ù„ ï·º: ÙƒÙÙ„ÙÙ…ÙØªÙØ§Ù†Ù Ø®ÙÙÙÙŠÙÙØªÙØ§Ù†Ù Ø¹ÙÙ„ÙÙ‰ Ø§Ù„Ù„ÙÙ‘Ø³ÙØ§Ù†Ù.. Ø³ÙØ¨Ù’Ø­ÙØ§Ù†Ù Ø§Ù„Ù„ÙÙ‘Ù‡Ù ÙˆÙØ¨ÙØ­ÙÙ…Ù’Ø¯ÙÙ‡Ù",
            "Ù‚Ø§Ù„ ï·º: Ù…ÙÙ†Ù’ ØµÙÙ„Ù‘ÙÙ‰ Ø¹ÙÙ„ÙÙŠÙ‘Ù ØµÙÙ„ÙØ§Ø©Ù‹ ØµÙÙ„Ù‘ÙÙ‰ Ø§Ù„Ù„Ù‘ÙÙ‡Ù Ø¹ÙÙ„ÙÙŠÙ’Ù‡Ù Ø¨ÙÙ‡ÙØ§ Ø¹ÙØ´Ù’Ø±Ù‹Ø§", "Ù‚Ø§Ù„ ï·º: Ø§Ù„Ø¯Ø§Ù„ Ø¹Ù„Ù‰ Ø§Ù„Ø®ÙŠØ± ÙƒÙØ§Ø¹Ù„Ù‡"
            // ÙŠØªÙ… Ø§Ø®ØªÙŠØ§Ø± Ø§Ù„Ø­Ø¯ÙŠØ« Ø¨Ù†Ø§Ø¡Ù‹ Ø¹Ù„Ù‰ Ø±Ù‚Ù… Ø§Ù„ÙŠÙˆÙ… ÙÙŠ Ø§Ù„Ø³Ù†Ø© (Day of Year) Ù„Ø¶Ù…Ø§Ù† Ø¹Ø¯Ù… Ø§Ù„ØªÙƒØ±Ø§Ø±
        ],
        flashes: ["Ø§Ù„Ø¶Ø­Ù‰ ØµÙ„Ø§Ø© Ø§Ù„Ø£ÙˆØ§Ø¨ÙŠÙ†", "ÙˆØ±Ø¯Ùƒ Ø§Ù„Ù‚Ø±Ø¢Ù†ÙŠ Ù†ÙˆØ± Ù‚Ù„Ø¨Ùƒ", "Ø§Ø°ÙƒØ± Ø§Ù„Ù„Ù‡ ÙŠØ°ÙƒØ±Ùƒ", "ØµÙ†Ø§Ø¦Ø¹ Ø§Ù„Ù…Ø¹Ø±ÙˆÙ ØªÙ‚ÙŠ Ù…ØµØ§Ø±Ø¹ Ø§Ù„Ø³ÙˆØ¡", "Ø¨Ø± Ø§Ù„ÙˆØ§Ù„Ø¯ÙŠÙ† Ù…ÙØªØ§Ø­ Ø§Ù„Ø¬Ù†Ø©"]
    };

    const sunnahs = [
        {id:"s1", n:"Ø³Ù†Ø© Ø§Ù„ÙØ¬Ø±", t:"Ù‚Ø¨Ù„ÙŠØ©", r:"2 Ø±ÙƒØ¹Ø©"}, {id:"s2", n:"Ø³Ù†Ø© Ø§Ù„Ø¸Ù‡Ø±", t:"Ù‚Ø¨Ù„ÙŠØ©", r:"4 Ø±ÙƒØ¹Ø©"},
        {id:"s3", n:"Ø³Ù†Ø© Ø§Ù„Ø¸Ù‡Ø±", t:"Ø¨Ø¹Ø¯ÙŠØ©", r:"2 Ø±ÙƒØ¹Ø©"}, {id:"s4", n:"Ø³Ù†Ø© Ø§Ù„Ù…ØºØ±Ø¨", t:"Ø¨Ø¹Ø¯ÙŠØ©", r:"2 Ø±ÙƒØ¹Ø©"},
        {id:"s5", n:"Ø³Ù†Ø© Ø§Ù„Ø¹Ø´Ø§Ø¡", t:"Ø¨Ø¹Ø¯ÙŠØ©", r:"2 Ø±ÙƒØ¹Ø©"}, {id:"s6", n:"Ø§Ù„Ø¶Ø­Ù‰", t:"Ù†Ø§ÙÙ„Ø©", r:"2-8 Ø±ÙƒØ¹Ø©"},
        {id:"s7", n:"Ø§Ù„ÙˆØªØ±", t:"Ù†Ø§ÙÙ„Ø©", r:"3 Ø±ÙƒØ¹Ø©"}, {id:"s8", n:"Ù‚ÙŠØ§Ù… Ø§Ù„Ù„ÙŠÙ„", t:"Ù†Ø§ÙÙ„Ø©", r:"Ù…Ø§ ØªÙŠØ³Ø±"}
    ];

    let currentUserIdx = 0;
    let familyData = [{name:"Ø§Ù„Ø£Ø¨ Ù…Ø­Ù…Ø¯", tasks:{}}, {name:"Ø§Ù„Ø£Ù… Ø´ÙŠÙ…Ø§Ø¡", tasks:{}}, {name:"Ø£Ø­Ù…Ø¯", tasks:{}}, {name:"ÙŠØ§Ø³ÙŠÙ†", tasks:{}}];

    function init() {
        const calendarEl = document.getElementById('main-calendar');
        if(!calendarEl.value) calendarEl.valueAsDate = new Date();
        
        const d = new Date(calendarEl.value);
        const dateKey = d.toISOString().split('T')[0];
        const isFriday = d.getDay() === 5;
        
        document.getElementById('display-date').innerText = d.toLocaleDateString('ar-EG', {weekday:'long', day:'numeric', month:'long'});

        // Ø§Ø®ØªÙŠØ§Ø± Ø­Ø¯ÙŠØ« ÙˆÙˆÙ…Ø¶Ø© Ø¨Ù†Ø§Ø¡Ù‹ Ø¹Ù„Ù‰ ØªØ±ØªÙŠØ¨ Ø§Ù„ÙŠÙˆÙ… ÙÙŠ Ø§Ù„Ø³Ù†Ø© Ù„Ø¶Ù…Ø§Ù† Ø§Ù„ØªØ¬Ø¯Ø¯ Ø§Ù„ÙŠÙˆÙ…ÙŠ
        const start = new Date(d.getFullYear(), 0, 0);
        const diff = d - start;
        const oneDay = 1000 * 60 * 60 * 24;
        const dayOfYear = Math.floor(diff / oneDay);
        
        const hIdx = dayOfYear % library.hadiths.length;
        const fIdx = dayOfYear % library.flashes.length;

        document.getElementById('spiritual-header').innerHTML = `
            <div class="luxury-card"><div class="card-inner"><p class="naskh">${library.hadiths[hIdx]}</p></div></div>
            <div class="luxury-card" style="border-color:var(--emerald);padding:5px"><p style="text-align:center;color:var(--emerald);margin:0">ğŸ’¡ ÙˆÙ…Ø¶Ø©: ${library.flashes[fIdx]}</p></div>`;

        // Ø§Ù„ØªØ²Ø§Ù…Ù† Ø§Ù„Ù„Ø­Ø¸ÙŠ
        db.ref('mehrab_v3/data').on('value', (snap) => {
            if(snap.exists()) familyData = snap.val();
            renderUI(dateKey, isFriday);
            const btnArea = document.getElementById('user-btns'); btnArea.innerHTML = "";
            familyData.forEach((u, i) => {
                btnArea.innerHTML += `<button class="user-btn ${i===currentUserIdx?'active':''}" onclick="switchUser(${i})">${u.name}</button>`;
            });
        });

        // Ø§Ù„Ø¯Ø±Ø¯Ø´Ø© (ØªØµÙÙŠØ± ÙŠÙˆÙ…ÙŠ Ø¹Ø¨Ø± dateKey)
        db.ref('mehrab_v3/chat/' + dateKey).on('value', (snap) => {
            const box = document.getElementById('chat-box'); box.innerHTML = "";
            if(snap.exists()) {
                Object.values(snap.val()).forEach(m => {
                    const isMe = m.s === familyData[currentUserIdx].name;
                    box.innerHTML += `<div class="msg ${isMe?'msg-sent':'msg-received'}"><b>${m.s}:</b> ${m.t}</div>`;
                });
                box.scrollTop = box.scrollHeight;
            } else { box.innerHTML = "<p style='text-align:center;color:#888;font-size:0.8rem;'>Ø¨Ø¯Ø§ÙŠØ© ÙŠÙˆÙ… Ø¬Ø¯ÙŠØ¯ Ù…Ù† Ø§Ù„Ø·Ø§Ø¹Ø§Øª..</p>"; }
        });
    }

    function switchUser(i) { currentUserIdx = i; init(); }

    function renderUI(dk, isFriday) {
        const ut = (familyData[currentUserIdx].tasks && familyData[currentUserIdx].tasks[dk]) ? familyData[currentUserIdx].tasks[dk] : {};
        
        // Ø§Ù„ÙØ±ÙˆØ¶ (ØªØ¨Ø¯ÙŠÙ„ Ø§Ù„Ø¸Ù‡Ø± Ø¨Ø§Ù„Ø¬Ù…Ø¹Ø©)
        const fList = document.getElementById('fard-list'); fList.innerHTML = "";
        const prayers = ["Ø§Ù„ÙØ¬Ø±", isFriday?"Ø§Ù„Ø¬Ù…Ø¹Ø©":"Ø§Ù„Ø¸Ù‡Ø±", "Ø§Ù„Ø¹ØµØ±", "Ø§Ù„Ù…ØºØ±Ø¨", "Ø§Ù„Ø¹Ø´Ø§Ø¡"];
        prayers.forEach(p => {
            const v = ut[p] || "";
            fList.innerHTML += `<div class="task-row"><span><b>${p}</b></span><div>
                <button class="opt-btn ${v==='m'?'active-masjid':''}" onclick="setT('${dk}','${p}','m')">ğŸ•Œ Ù…Ø³Ø¬Ø¯</button>
                <button class="opt-btn ${v==='f'?'active-fard':''}" onclick="setT('${dk}','${p}','f')">ğŸ‘¤ ÙØ±Ø¯</button>
            </div></div>`;
        });

        // Ø§Ù„Ø³Ù†Ù†
        const sList = document.getElementById('sunnah-list'); sList.innerHTML = "";
        sunnahs.forEach(s => {
            sList.innerHTML += `<div class="task-row"><span>${s.n} <span class="badge">${s.t} - ${s.r}</span></span><input type="checkbox" ${ut[s.id]?'checked':''} onchange="setCheck('${dk}','${s.id}',this.checked)"></div>`;
        });

        // Ø§Ù„Ø£Ø°ÙƒØ§Ø± + Ø³ÙˆØ±Ø© Ø§Ù„Ù…Ù„Ùƒ (Ø«Ø§Ø¨ØªØ©) + Ø³ÙˆØ±Ø© Ø§Ù„ÙƒÙ‡Ù (Ø¬Ù…Ø¹Ø©)
        const wList = document.getElementById('words-list'); wList.innerHTML = `
            <div class="task-row"><span><a href="https://alazkar.today" target="_blank" class="ext-link">Ø£Ø°ÙƒØ§Ø± Ø§Ù„ØµØ¨Ø§Ø­ ğŸ”—</a></span><input type="checkbox" ${ut.az_s?'checked':''} onchange="setCheck('${dk}','az_s',this.checked)"></div>
            <div class="task-row"><span><a href="https://alazkar.today" target="_blank" class="ext-link">Ø£Ø°ÙƒØ§Ø± Ø§Ù„Ù…Ø³Ø§Ø¡ ğŸ”—</a></span><input type="checkbox" ${ut.az_m?'checked':''} onchange="setCheck('${dk}','az_m',this.checked)"></div>
            <div class="task-row"><span><a href="https://quran.com" target="_blank" class="ext-link">Ø§Ù„ÙˆØ±Ø¯ Ø§Ù„Ù‚Ø±Ø¢Ù†ÙŠ ğŸ”—</a></span><input type="checkbox" ${ut.qr?'checked':''} onchange="setCheck('${dk}','qr',this.checked)"></div>
            <div class="task-row"><span><a href="https://quran.com/67" target="_blank" class="ext-link">Ø³ÙˆØ±Ø© Ø§Ù„Ù…Ù„Ùƒ ğŸ”—</a></span><input type="checkbox" ${ut.mk?'checked':''} onchange="setCheck('${dk}','mk',this.checked)"></div>`;
        
        if(isFriday) {
            wList.innerHTML += `<div class="task-row" style="color:var(--emerald)"><span><b><a href="https://quran.com/18" target="_blank" class="ext-link" style="color:var(--emerald)">Ø³ÙˆØ±Ø© Ø§Ù„ÙƒÙ‡Ù ğŸ”—</a></b></span><input type="checkbox" ${ut.kf?'checked':''} onchange="setCheck('${dk}','kf',this.checked)"></div>`;
        }
        updatePodium(dk, isFriday);
    }

    function setT(dk, p, v) {
        if(!familyData[currentUserIdx].tasks) familyData[currentUserIdx].tasks = {};
        if(!familyData[currentUserIdx].tasks[dk]) familyData[currentUserIdx].tasks[dk] = {};
        familyData[currentUserIdx].tasks[dk][p] = (familyData[currentUserIdx].tasks[dk][p] === v) ? "" : v;
        db.ref('mehrab_v3/data').set(familyData);
    }

    function setCheck(dk, k, v) {
        if(!familyData[currentUserIdx].tasks) familyData[currentUserIdx].tasks = {};
        if(!familyData[currentUserIdx].tasks[dk]) familyData[currentUserIdx].tasks[dk] = {};
        familyData[currentUserIdx].tasks[dk][k] = v;
        db.ref('mehrab_v3/data').set(familyData);
    }

    function updatePodium(dk, isFriday) {
        const track = ["Ø§Ù„ÙØ¬Ø±", isFriday?"Ø§Ù„Ø¬Ù…Ø¹Ø©":"Ø§Ù„Ø¸Ù‡Ø±", "Ø§Ù„Ø¹ØµØ±", "Ø§Ù„Ù…ØºØ±Ø¨", "Ø§Ù„Ø¹Ø´Ø§Ø¡", "s1", "s2", "s3", "s4", "s5", "az_s", "az_m", "qr", "mk"];
        if(isFriday) track.push("kf");
        
        const results = familyData.map(u => {
            const ut = (u.tasks && u.tasks[dk]) ? u.tasks[dk] : {};
            let done = 0, rem = [];
            track.forEach(id => {
                if(ut[id]===true || ut[id]==='m' || ut[id]==='f') done++;
                else { 
                    let l = id.startsWith('s')?sunnahs.find(x=>x.id===id).n:id;
                    l = l.replace('az_s','Ø§Ù„Ø£Ø°ÙƒØ§Ø±').replace('az_m','Ø§Ù„Ø£Ø°ÙƒØ§Ø±').replace('qr','Ø§Ù„ÙˆØ±Ø¯').replace('mk','Ø§Ù„Ù…Ù„Ùƒ').replace('kf','Ø§Ù„ÙƒÙ‡Ù');
                    if(!rem.includes(l)) rem.push(l);
                }
            });
            return { name: u.name, score: Math.round((done/track.length)*100), rem };
        }).sort((a,b) => b.score - a.score);

        const ui = document.getElementById('podium-ui'); ui.innerHTML = "";
        [results[1], results[0], results[2], results[3]].forEach((m, i) => {
            if(!m) return;
            const step = m === results[0] ? "step-1" : (m === results[1] ? "step-2" : (m === results[2] ? "step-3" : "step-4"));
            ui.innerHTML += `<div class="podium-step ${step}"><span class="medal">${m===results[0]?'ğŸ¥‡':m===results[1]?'ğŸ¥ˆ':m===results[2]?'ğŸ¥‰':'ğŸ…'}</span><b style="font-size:0.75rem">${m.name.split(' ')[0]}</b><span>${m.score}%</span><div class="remain-box">${m.rem.length > 0 ? m.rem.slice(0,2).join(', ') : 'Ø§ÙƒØªÙ…Ù„!'}</div></div>`;
        });
    }

    function sendMessage() {
        const inp = document.getElementById('chat-input'); if(!inp.value.trim()) return;
        const dk = document.getElementById('main-calendar').value;
        db.ref('mehrab_v3/chat/' + dk).push({ s: familyData[currentUserIdx].name, t: inp.value });
        inp.value = "";
    }
    window.onload = init;
</script>
</body>
</html>
